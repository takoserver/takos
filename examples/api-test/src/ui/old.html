<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêô Takos API Test Extension</title>
    <style>
        :root {
            --primary-color: #007acc;
            --primary-hover: #005a9e;
            --success-color: #4caf50;
            --error-color: #f44336;
            --info-color: #2196f3;
            --warning-color: #ff9800;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --border-color: #ddd;
            --text-color: #333;
            --text-muted: #666;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            color: var(--primary-color);
        }

        .header p {
            margin: 10px 0 0 0;
            color: var(--text-muted);
            font-size: 1.1em;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .test-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .test-section h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--text-color);
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .layer-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .layer-server { background: #f3e5f5; color: #7b1fa2; }
        .layer-client { background: #e8f5e8; color: #388e3c; }
        .layer-ui { background: #e3f2fd; color: #1976d2; }
        .layer-api { background: #fff3e0; color: #f57c00; }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 120px;
        }

        button:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,122,204,0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-warning {
            background: var(--warning-color);
        }

        .btn-warning:hover {
            background: #e68900;
        }

        .btn-danger {
            background: var(--error-color);
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .output-section {
            margin-top: 30px;
        }

        .output {
            background: #1e1e1e;
            color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid var(--border-color);
        }

        .output:empty::before {
            content: "„ÉÜ„Çπ„ÉàÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô...";
            color: #888;
            font-style: italic;
        }

        .log-success { color: var(--success-color); }
        .log-error { color: var(--error-color); }
        .log-info { color: var(--info-color); }
        .log-warning { color: var(--warning-color); }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .quick-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .result-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 14px;
        }

        .icon {
            font-size: 1.2em;
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .test-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                flex-direction: column;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêô Takos API Test Extension</h1>
            <p>Comprehensive testing suite for all Takos APIs including ActivityPub, KV storage, CDN, Events, and Extensions</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <span class="status-dot"></span>
                <span>Extension Active</span>
            </div>
            <div class="status-item">
                <span>üïí</span>
                <span id="current-time">--:--:--</span>
            </div>
            <div class="status-item">
                <span>üîß</span>
                <span>v1.0.0</span>
            </div>
        </div>

        <div class="quick-actions">
            <button onclick="runAllTests()" class="btn-success">
                <span class="icon">‚ö°</span> ÂÖ®API„ÉÜ„Çπ„ÉàÂÆüË°å
            </button>
            <button onclick="runServerTests()" class="btn-warning">
                <span class="icon">üñ•Ô∏è</span> „Çµ„Éº„Éê„Éº„ÉÜ„Çπ„Éà
            </button>
            <button onclick="runClientTests()">
                <span class="icon">üíª</span> „ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÉÜ„Çπ„Éà
            </button>
            <button onclick="clearOutput()" class="btn-danger">
                <span class="icon">üóëÔ∏è</span> „É≠„Ç∞„ÇØ„É™„Ç¢
            </button>
        </div>

        <div class="test-grid">
            <!-- ActivityPub API Tests -->
            <div class="test-section">
                <h2>
                    <span class="layer-badge layer-api">ActivityPub</span>
                    <span class="icon">üåê</span> ActivityPub API
                </h2>
                <div class="button-group">
                    <button onclick="testActivityPubSend()" class="tooltip" data-tooltip="ActivityPub„ÅßNote„ÇíÈÄÅ‰ø°">
                        Send Note
                    </button>
                    <button onclick="testActivityPubList()" class="tooltip" data-tooltip="ÈÄÅ‰ø°Ê∏à„Åø„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„ÅÆ‰∏ÄË¶ßÂèñÂæó">
                        List Activities
                    </button>
                    <button onclick="testActivityPubActor()" class="tooltip" data-tooltip="„Ç¢„ÇØ„Çø„ÉºÊÉÖÂ†±„ÅÆË™≠„ÅøÂèñ„Çä„Å®Êõ¥Êñ∞">
                        Actor Test
                    </button>
                    <button onclick="testPluginActor()" class="tooltip" data-tooltip="„Éó„É©„Ç∞„Ç§„É≥„Ç¢„ÇØ„Çø„Éº„ÅÆ‰ΩúÊàê„Å®„ÉÜ„Çπ„Éà">
                        Plugin Actor
                    </button>
                </div>
            </div>

            <!-- Storage API Tests -->
            <div class="test-section">
                <h2>
                    <span class="layer-badge layer-server">Storage</span>
                    <span class="icon">üíæ</span> Storage APIs
                </h2>
                <div class="button-group">
                    <button onclick="testKVOperations()" class="tooltip" data-tooltip="„Çµ„Éº„Éê„Éº„Çµ„Ç§„ÉâKV„Çπ„Éà„É¨„Éº„Ç∏„ÉÜ„Çπ„Éà">
                        Server KV
                    </button>
                    <button onclick="testClientKV()" class="tooltip" data-tooltip="„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çµ„Ç§„ÉâKV„Çπ„Éà„É¨„Éº„Ç∏„ÉÜ„Çπ„Éà">
                        Client KV
                    </button>
                    <button onclick="testCDNOperations()" class="tooltip" data-tooltip="CDN„Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ/„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ">
                        CDN Test
                    </button>
                </div>
            </div>

            <!-- Network API Tests -->
            <div class="test-section">
                <h2>
                    <span class="layer-badge layer-api">Network</span>
                    <span class="icon">üåê</span> Network APIs
                </h2>
                <div class="button-group">
                    <button onclick="testFetchAPI()" class="tooltip" data-tooltip="HTTP fetch API „ÉÜ„Çπ„Éà">
                        Fetch API
                    </button>
                    <button onclick="testClientFetch()" class="tooltip" data-tooltip="„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çµ„Ç§„Éâfetch (Âà∂Èôê„ÅÇ„Çä)">
                        Client Fetch
                    </button>
                </div>
            </div>

            <!-- Events API Tests -->
            <div class="test-section">
                <h2>
                    <span class="layer-badge layer-client">Events</span>
                    <span class="icon">üì°</span> Events API
                </h2>
                <div class="button-group">
                    <button onclick="testEventsAPI()" class="tooltip" data-tooltip="„É¨„Ç§„É§„ÉºÈñì„Ç§„Éô„É≥„ÉàÈÄö‰ø°„ÉÜ„Çπ„Éà">
                        Events Test
                    </button>
                    <button onclick="sendEventToServer()" class="tooltip" data-tooltip="UI„Åã„Çâ„Çµ„Éº„Éê„Éº„Å∏„Ç§„Éô„É≥„ÉàÈÄÅ‰ø°">
                        UI ‚Üí Server
                    </button>                    <button onclick="sendEventToClient()" class="tooltip" data-tooltip="UI„Åã„Çâ„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Å∏„Ç§„Éô„É≥„ÉàÈÄÅ‰ø°">
                        UI ‚Üí Client
                    </button>
                </div>
            </div>

            <!-- Extensions API Tests -->
            <div class="test-section">
                <h2>
                    <span class="layer-badge layer-api">Extensions</span>
                    <span class="icon">üîß</span> Extensions API
                </h2>
                <div class="button-group">
                    <button onclick="testExtensionsAPI()" class="tooltip" data-tooltip="Êã°ÂºµÊ©üËÉΩ„ÅÆ‰∏ÄË¶ß„Å®Âëº„Å≥Âá∫„Åó„ÉÜ„Çπ„Éà">
                        Extensions List
                    </button>
                    <button onclick="testClientExtensions()" class="tooltip" data-tooltip="„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂÅ¥Êã°ÂºµÊ©üËÉΩ„ÉÜ„Çπ„Éà">
                        Client Extensions
                    </button>
                    <button onclick="invokeExtensionFunction()" class="tooltip" data-tooltip="‰ªñ„ÅÆÊã°ÂºµÊ©üËÉΩ„ÅÆÈñ¢Êï∞Âëº„Å≥Âá∫„Åó">
                        Invoke Test
                    </button>
                </div>
            </div>

            <!-- Layer Communication Tests -->
            <div class="test-section">
                <h2>
                    <span class="layer-badge layer-ui">Communication</span>
                    <span class="icon">üîÑ</span> Layer Communication
                </h2>
                <div class="button-group">
                    <button onclick="callServerFunction()" class="tooltip" data-tooltip="UI„Åã„Çâ„Çµ„Éº„Éê„ÉºÈñ¢Êï∞„ÅÆÁõ¥Êé•Âëº„Å≥Âá∫„Åó">
                        UI ‚Üí Server Call
                    </button>
                    <button onclick="callClientFunction()" class="tooltip" data-tooltip="UI„Åã„Çâ„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÈñ¢Êï∞„ÅÆÂëº„Å≥Âá∫„Åó">
                        UI ‚Üí Client Call
                    </button>
                    <button onclick="testLayerCommunication()" class="tooltip" data-tooltip="ÂÖ®„É¨„Ç§„É§„ÉºÈñì„ÅÆÈÄö‰ø°„ÉÜ„Çπ„Éà">
                        All Layers
                    </button>
                </div>
            </div>
        </div>

        <div class="output-section">
            <h2>
                <span class="icon">üìã</span> „ÉÜ„Çπ„ÉàÁµêÊûú
                <button onclick="exportResults()" style="margin-left: 15px; font-size: 12px; padding: 5px 10px;">
                    üìÑ ÁµêÊûú„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                </button>
            </h2>
            <div id="output" class="output"></div>
            <div class="button-group">
                <button onclick="clearOutput()" class="btn-danger">„É≠„Ç∞„ÇØ„É™„Ç¢</button>
                <button onclick="toggleLogLevel()">„É≠„Ç∞„É¨„Éô„É´Â§âÊõ¥</button>
                <button onclick="copyOutput()">üìã „Ç≥„Éî„Éº</button>
            </div>
        </div>
    </div>

    <script>
        // deno-lint-ignore-file no-explicit-any
        const { takos } = globalThis;
        
        let logLevel = 'all'; // 'all', 'success', 'error'
        let testResults = [];

        // Exported UI function
        window.apiTestUI = function(testType, params) {
            log(`[UI] apiTestUI called with: ${testType}`, 'info');
            return {
                layer: "ui",
                testType,
                params,
                timestamp: new Date().toISOString(),
                result: `UI processed ${testType} test`
            };
        };

        // Utility functions
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString();
        }
        setInterval(updateTime, 1000);
        updateTime();

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = `log-${type}`;
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            if (logLevel === 'all' || logLevel === type) {
                const output = document.getElementById('output');
                output.innerHTML += `<span class="${className}">[${timestamp}] ${icon} ${message}</span>\n`;
                output.scrollTop = output.scrollHeight;
            }
            
            // Store for export
            testResults.push({ timestamp, type, message });
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
            testResults = [];
            log('„É≠„Ç∞„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', 'info');
        }

        function toggleLogLevel() {
            const levels = ['all', 'success', 'error'];
            const currentIndex = levels.indexOf(logLevel);
            logLevel = levels[(currentIndex + 1) % levels.length];
            log(`„É≠„Ç∞„É¨„Éô„É´„Çí ${logLevel} „Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`, 'info');
        }

        function copyOutput() {
            const output = document.getElementById('output');
            navigator.clipboard.writeText(output.textContent).then(() => {
                log('„É≠„Ç∞„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
            }).catch(err => {
                log('„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å∏„ÅÆ„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message, 'error');
            });
        }

        function exportResults() {
            const data = {
                timestamp: new Date().toISOString(),
                testResults,
                extension: 'jp.takos.api-test',
                version: '1.0.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `takos-api-test-results-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
              log('„ÉÜ„Çπ„ÉàÁµêÊûú„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü', 'success');
        }
        
        // =============================================================================
        // ActivityPub API Tests
        // =============================================================================
        
        async function testActivityPubSend() {
            try {
                log('[UI] ActivityPub send test „ÇíÈñãÂßã...', 'info');
                
                // Êã°ÂºµÊ©üËÉΩ„ÇíÊúâÂäπÂåñ„Åó„Å¶„Åã„ÇâÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
                const ext = takos.extensions.get("jp.takos.api-test");
                if (!ext) {
                    log('[UI] Êã°ÂºµÊ©üËÉΩ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: jp.takos.api-test', 'error');
                    return;
                }

                const result = await ext.request("testActivityPubSend");
                
                if (result && result[0] === 200) {
                    log(`[UI] ActivityPub send test ÊàêÂäü: ${JSON.stringify(result[1], null, 2)}`, 'success');
                } else if (result && result.error) {
                    log(`[UI] ActivityPub send test Â§±Êïó: ${result.error}`, 'error');
                } else {
                    log(`[UI] ActivityPub send test Â§±Êïó: ${JSON.stringify(result, null, 2)}`, 'error');
                }
            } catch (error) {
                log(`[UI] ActivityPub send test „Ç®„É©„Éº: ${error.message}`, 'error');
                console.error('ActivityPub send test detailed error:', error);
            }
        }

        async function testActivityPubList() {
            try {
                log('[UI] ActivityPub list test „ÇíÈñãÂßã...', 'info');
                
                const result = await takos.extensions.invoke("jp.takos.api-test", "testActivityPubList", []);
                
                if (result && result[0] === 200) {
                    log(`[UI] ActivityPub list test ÊàêÂäü: ${result[1].count} ‰ª∂„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„ÇíÁô∫Ë¶ã`, 'success');
                    log(`Ë©≥Á¥∞: ${JSON.stringify(result[1], null, 2)}`, 'info');
                } else {
                    log(`[UI] ActivityPub list test Â§±Êïó: ${JSON.stringify(result, null, 2)}`, 'error');
                }
            } catch (error) {
                log(`[UI] ActivityPub list test „Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        async function testActivityPubActor() {
            try {
                log('[UI] ActivityPub actor test „ÇíÈñãÂßã...', 'info');
                
                const result = await takos.extensions.invoke("jp.takos.api-test", "testActivityPubActor", []);
                
                if (result && result[0] === 200) {
                    log(`[UI] ActivityPub actor test ÊàêÂäü`, 'success');
                    log(`„Ç¢„ÇØ„Çø„ÉºÊÉÖÂ†±: ${JSON.stringify(result[1].actor, null, 2)}`, 'info');
                } else {
                    log(`[UI] ActivityPub actor test Â§±Êïó: ${JSON.stringify(result, null, 2)}`, 'error');
                }
            } catch (error) {
                log(`[UI] ActivityPub actor test „Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        async function testPluginActor() {
            try {
                log('[UI] Plugin actor test „ÇíÈñãÂßã...', 'info');
                
                const result = await takos.extensions.invoke("jp.takos.api-test", "testPluginActor", []);
                
                if (result && result[0] === 200) {
                    log(`[UI] Plugin actor test ÊàêÂäü`, 'success');
                    log(`‰ΩúÊàê„Åï„Çå„Åü„Ç¢„ÇØ„Çø„Éº: ${result[1].createdActor}`, 'info');
                    log(`Á∑è„Ç¢„ÇØ„Çø„ÉºÊï∞: ${result[1].totalActors}`, 'info');
                } else {
                    log(`[UI] Plugin actor test Â§±Êïó: ${JSON.stringify(result, null, 2)}`, 'error');
                }
            } catch (error) {
                log(`[UI] Plugin actor test „Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }
        
        // =============================================================================
        // Storage API Tests
        // =============================================================================
        
        async function testKVOperations() {
            try {
                log('[UI] Server KV operations test „ÇíÈñãÂßã...', 'info');
                
                // Êã°ÂºµÊ©üËÉΩ„ÇíÊúâÂäπÂåñ„Åó„Å¶„Åã„ÇâÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
                const extension = takos.extensions.get("jp.takos.api-test");
                if (!extension) {
                    log('[UI] Êã°ÂºµÊ©üËÉΩ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: jp.takos.api-test', 'error');
                    return;
                }

                const result = await extension.request("testKVOperations");
                
                if (result && result[0] === 200) {
                    log(`[UI] Server KV test ÊàêÂäü: ${result[1].keysCount} „Ç≠„Éº„ÇíÁ¢∫Ë™ç`, 'success');
                    log(`„ÉÜ„Çπ„Éà„Ç≠„Éº: ${result[1].testKey}`, 'info');
                } else if (result && result.error) {
                    log(`[UI] Server KV test Â§±Êïó: ${result.error}`, 'error');
                } else {
                    log(`[UI] Server KV test Â§±Êïó: ${JSON.stringify(result, null, 2)}`, 'error');
                }
            } catch (error) {
                log(`[UI] Server KV test „Ç®„É©„Éº: ${error.message}`, 'error');
                console.error('Server KV test detailed error:', error);
            }
        }
        async function testClientKV() {
            try {
                log('[UI] Client KV operations test „ÇíÈñãÂßã...', 'info');
                
                // Êã°ÂºµÊ©üËÉΩ„ÇíÊúâÂäπÂåñ„Åó„Å¶„Åã„ÇâÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
                const extension = takos.extensions.get("jp.takos.api-test");
                if (!extension) {
                    log('[UI] Êã°ÂºµÊ©üËÉΩ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: jp.takos.api-test', 'error');
                    return;
                }

                const result = await extension.request("testClientKV");
                
                if (result && result.success) {
                    log(`[UI] Client KV test ÊàêÂäü: ${result.keysCount} „Ç≠„Éº„ÇíÁ¢∫Ë™ç`, 'success');
                    log(`„ÉÜ„Çπ„Éà„Ç≠„Éº: ${result.testKey}`, 'info');
                    log(`Ê≥®ÊÑè: ${result.note}`, 'warning');
                } else if (result && result.error) {
                    log(`[UI] Client KV test Â§±Êïó: ${result.error}`, 'error');
                } else if (result === undefined || result === null) {
                    log(`[UI] Client KV test: Èñ¢Êï∞„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„ÅãÂÆüË°å„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü`, 'warning');
                } else {
                    log(`[UI] Client KV test ‰∏çÊòé„Å™ÁµêÊûú: ${JSON.stringify(result)}`, 'warning');
                }
            } catch (error) {
                log(`[UI] Client KV test „Ç®„É©„Éº: ${error.message}`, 'error');
                console.error('Client KV test detailed error:', error);
            }
        }
        
        async function testCDNOperations() {
            try {
                log('[UI] CDN operations test „ÇíÈñãÂßã...', 'info');
                
                // Êã°ÂºµÊ©üËÉΩ„ÇíÊúâÂäπÂåñ„Åó„Å¶„Åã„ÇâÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
                const extension = takos.extensions.get("jp.takos.api-test");
                if (!extension) {
                    log('[UI] Êã°ÂºµÊ©üËÉΩ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: jp.takos.api-test', 'error');
                    return;
                }

                const result = await extension.request("testCDNOperations");
                
                if (result && result[0] === 200) {
                    log(`[UI] CDN test ÊàêÂäü`, 'success');
                    log(`CDN URL: ${result[1].url}`, 'info');
                    log(`„Éï„Ç°„Ç§„É´Êï∞: ${result[1].filesCount}`, 'info');
                } else if (result && result.error) {
                    log(`[UI] CDN test Â§±Êïó: ${result.error}`, 'error');
                } else if (result === undefined || result === null) {
                    log(`[UI] CDN test: Èñ¢Êï∞„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„ÅãÂÆüË°å„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü`, 'warning');
                } else {
                    log(`[UI] CDN test Â§±Êïó: ${JSON.stringify(result, null, 2)}`, 'error');
                }
            } catch (error) {
                log(`[UI] CDN test „Ç®„É©„Éº: ${error.message}`, 'error');
                console.error('CDN test detailed error:', error);
            }
        }

        // =============================================================================
        // Network API Tests
        // =============================================================================

        async function testFetchAPI() {
            try {
                log('[UI] Server Fetch API test „ÇíÈñãÂßã...', 'info');
                
                const result = await takos.extensions.invoke("jp.takos.api-test", "testFetchAPI", []);
                
                if (result && result[0] === 200) {
                    log(`[UI] Server Fetch test ÊàêÂäü`, 'success');
                    log(`„É¨„Çπ„Éù„É≥„Çπ: ${result[1].data.title}`, 'info');
                } else {
                    log(`[UI] Server Fetch test Â§±Êïó: ${JSON.stringify(result, null, 2)}`, 'error');
                }
            } catch (error) {
                log(`[UI] Server Fetch test „Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        async function testClientFetch() {
            try {
                log('[UI] Client Fetch API test „ÇíÈñãÂßã...', 'info');
                
                const result = await takos.extensions.invoke("jp.takos.api-test", "testClientFetch", []);
                
                if (result && result.success) {
                    log(`[UI] Client Fetch test ÊàêÂäü`, 'success');
                    log(`„É¨„Çπ„Éù„É≥„Çπ: ${result.data.title}`, 'info');
                    if (result.note) {
                        log(`Ê≥®ÊÑè: ${result.note}`, 'warning');
                    }
                } else {
                    log(`[UI] Client Fetch test Â§±Êïó: ${result.error}`, 'error');
                    if (result.note) {
                        log(`Ê≥®ÊÑè: ${result.note}`, 'warning');
                    }
                }
            } catch (error) {
                log(`[UI] Client Fetch test „Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        // =============================================================================
        // Events API Tests
        // =============================================================================

        async function testEventsAPI() {
            try {
                log('[UI] Events API test „ÇíÈñãÂßã...', 'info');
                
                const result = await takos.extensions.invoke("jp.takos.api-test", "testEventsAPI", []);
                
                if (result && result[0] === 200) {
                    log(`[UI] Events API test ÊàêÂäü: ${result[1].message}`, 'success');
                } else {
                    log(`[UI] Events API test Â§±Êïó: ${JSON.stringify(result, null, 2)}`, 'error');
                }
            } catch (error) {
                log(`[UI] Events API test „Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        async function sendEventToServer() {
            try {
                log('[UI] UI„Åã„Çâ„Çµ„Éº„Éê„Éº„Å∏„Ç§„Éô„É≥„ÉàÈÄÅ‰ø°...', 'info');
                
                const result = await takos.events.publish("uiToServer", {
                    message: "Hello from UI to Server!",
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent
                });
                
                log(`[UI] „Çµ„Éº„Éê„Éº„Ç§„Éô„É≥„ÉàÈÄÅ‰ø°ÊàêÂäü: ${JSON.stringify(result, null, 2)}`, 'success');
            } catch (error) {
                log(`[UI] „Çµ„Éº„Éê„Éº„Ç§„Éô„É≥„ÉàÈÄÅ‰ø°„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        async function sendEventToClient() {
            try {
                log('[UI] UI„Åã„Çâ„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Å∏„Ç§„Éô„É≥„ÉàÈÄÅ‰ø°...', 'info');
                
                await takos.events.publish("uiToClient", {
                    message: "Hello from UI to Client!",
                    timestamp: new Date().toISOString(),
                    windowSize: { width: window.innerWidth, height: window.innerHeight }
                });
                
                log(`[UI] „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Ç§„Éô„É≥„ÉàÈÄÅ‰ø°ÊàêÂäü`, 'success');
            } catch (error) {
                log(`[UI] „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Ç§„Éô„É≥„ÉàÈÄÅ‰ø°„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        // =============================================================================
        // Extensions API Tests
        // =============================================================================

        async function testExtensionsAPI() {
            try {
                log('[UI] Extensions API test „ÇíÈñãÂßã...', 'info');
                
                const result = await takos.extensions.invoke("jp.takos.api-test", "testExtensionsAPI", []);
                
                if (result && result[0] === 200) {
                    log(`[UI] Extensions API test ÊàêÂäü`, 'success');
                    log(`Á∑èÊã°ÂºµÊ©üËÉΩÊï∞: ${result[1].totalExtensions}`, 'info');
                    result[1].extensions.forEach(ext => {
                        log(`  - ${ext.identifier} v${ext.version} (${ext.isActive ? 'Active' : 'Inactive'})`, 'info');
                    });
                } else {
                    log(`[UI] Extensions API test Â§±Êïó: ${JSON.stringify(result, null, 2)}`, 'error');
                }
            } catch (error) {
                log(`[UI] Extensions API test „Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        async function testClientExtensions() {
            try {
                log('[UI] Client Extensions test „ÇíÈñãÂßã...', 'info');
                
                const result = await takos.extensions.invoke("jp.takos.api-test", "testClientExtensions", []);
                
                if (result && result.success) {
                    log(`[UI] Client Extensions test ÊàêÂäü`, 'success');
                    log(`Á∑èÊã°ÂºµÊ©üËÉΩÊï∞: ${result.totalExtensions}`, 'info');
                    if (result.invokeTest) {
                        log(`Êã°ÂºµÊ©üËÉΩÂëº„Å≥Âá∫„Åó„ÉÜ„Çπ„ÉàÁµêÊûú: ${JSON.stringify(result.invokeTest, null, 2)}`, 'info');
                    }
                } else {
                    log(`[UI] Client Extensions test Â§±Êïó: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`[UI] Client Extensions test „Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        async function invokeExtensionFunction() {
            try {
                log('[UI] Êã°ÂºµÊ©üËÉΩÈñ¢Êï∞Âëº„Å≥Âá∫„Åó„ÉÜ„Çπ„Éà...', 'info');
                
                // Ëá™ÂàÜËá™Ë∫´„ÅÆ„Çµ„Éº„Éê„ÉºÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åó
                const result = await takos.extensions.invoke("jp.takos.api-test", "apiTestServer", ["invoke-test", { from: "ui" }]);
                
                log(`[UI] Êã°ÂºµÊ©üËÉΩÂëº„Å≥Âá∫„ÅóÊàêÂäü: ${JSON.stringify(result, null, 2)}`, 'success');
            } catch (error) {
                log(`[UI] Êã°ÂºµÊ©üËÉΩÂëº„Å≥Âá∫„Åó„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        // =============================================================================
        // Layer Communication Tests
        // =============================================================================

        async function callServerFunction() {
            try {
                log('[UI] „Çµ„Éº„Éê„ÉºÈñ¢Êï∞Áõ¥Êé•Âëº„Å≥Âá∫„Åó...', 'info');
                
                const result = await takos.extensions.invoke("jp.takos.api-test", "apiTestServer", ["direct-call", { layer: "ui" }]);
                
                log(`[UI] „Çµ„Éº„Éê„ÉºÈñ¢Êï∞Âëº„Å≥Âá∫„ÅóÊàêÂäü: ${JSON.stringify(result, null, 2)}`, 'success');
            } catch (error) {
                log(`[UI] „Çµ„Éº„Éê„ÉºÈñ¢Êï∞Âëº„Å≥Âá∫„Åó„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        async function callClientFunction() {
            try {
                log('[UI] „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÈñ¢Êï∞Âëº„Å≥Âá∫„Åó...', 'info');
                
                // „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÈñ¢Êï∞„ÅØÁõ¥Êé•Âëº„Å≥Âá∫„Åõ„Å™„ÅÑ„ÅÆ„Åß„ÄÅ„Ç§„Éô„É≥„ÉàÁµåÁî±
                await takos.events.publish("uiToClient", {
                    type: "function-call",
                    functionName: "apiTestClient",
                    params: ["call-from-ui", { layer: "ui" }],
                    timestamp: new Date().toISOString()
                });
                
                log(`[UI] „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÈñ¢Êï∞Âëº„Å≥Âá∫„Åó„Ç§„Éô„É≥„ÉàÈÄÅ‰ø°ÂÆå‰∫Ü`, 'success');
            } catch (error) {
                log(`[UI] „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÈñ¢Êï∞Âëº„Å≥Âá∫„Åó„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        async function testLayerCommunication() {
            try {
                log('[UI] ÂÖ®„É¨„Ç§„É§„ÉºÈñìÈÄö‰ø°„ÉÜ„Çπ„ÉàÈñãÂßã...', 'info');
                
                // 1. Server function call
                await callServerFunction();
                
                // 2. Client function call
                await callClientFunction();
                
                // 3. Event tests
                await sendEventToServer();
                await sendEventToClient();
                
                log('[UI] ÂÖ®„É¨„Ç§„É§„ÉºÈñìÈÄö‰ø°„ÉÜ„Çπ„ÉàÂÆå‰∫Ü', 'success');
            } catch (error) {
                log(`[UI] „É¨„Ç§„É§„ÉºÈñìÈÄö‰ø°„ÉÜ„Çπ„Éà„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        // =============================================================================
        // Comprehensive Tests
        // =============================================================================

        async function runServerTests() {
            try {
                log('[UI] „Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„ÉÜ„Çπ„ÉàÂÆüË°å‰∏≠...', 'info');
                
                const result = await takos.extensions.invoke("jp.takos.api-test", "runAllTests", []);
                
                if (result && result[0] === 200) {
                    const summary = result[1].summary;
                    log(`[UI] „Çµ„Éº„Éê„Éº„ÉÜ„Çπ„ÉàÂÆå‰∫Ü: ${summary.passed}/${summary.total} ÊàêÂäü`, 
                        summary.failed === 0 ? 'success' : 'warning');
                    
                    // Ë©≥Á¥∞ÁµêÊûú„Çí„É≠„Ç∞Âá∫Âäõ
                    Object.entries(result[1].results).forEach(([testName, testResult]) => {
                        const status = testResult.success ? '‚úÖ' : '‚ùå';
                        log(`  ${status} ${testName}: ${testResult.success ? 'PASS' : 'FAIL'}`, 
                            testResult.success ? 'success' : 'error');
                        if (!testResult.success && testResult.error) {
                            log(`    „Ç®„É©„Éº: ${testResult.error}`, 'error');
                        }
                    });
                } else {
                    log(`[UI] „Çµ„Éº„Éê„Éº„ÉÜ„Çπ„ÉàÂ§±Êïó: ${JSON.stringify(result, null, 2)}`, 'error');
                }
            } catch (error) {
                log(`[UI] „Çµ„Éº„Éê„Éº„ÉÜ„Çπ„ÉàÂÆüË°å„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        async function runClientTests() {
            try {
                log('[UI] „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çµ„Ç§„Éâ„ÉÜ„Çπ„ÉàÂÆüË°å‰∏≠...', 'info');
                
                const result = await takos.extensions.invoke("jp.takos.api-test", "runClientTests", []);
                
                if (result && result.success) {
                    const summary = result.summary;
                    log(`[UI] „ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÉÜ„Çπ„ÉàÂÆå‰∫Ü: ${summary.passed}/${summary.total} ÊàêÂäü`, 
                        summary.failed === 0 ? 'success' : 'warning');
                    
                    // Ë©≥Á¥∞ÁµêÊûú„Çí„É≠„Ç∞Âá∫Âäõ
                    Object.entries(result.results).forEach(([testName, testResult]) => {
                        const status = testResult.success ? '‚úÖ' : '‚ùå';
                        log(`  ${status} ${testName}: ${testResult.success ? 'PASS' : 'FAIL'}`, 
                            testResult.success ? 'success' : 'error');
                        if (!testResult.success && testResult.error) {
                            log(`    „Ç®„É©„Éº: ${testResult.error}`, 'error');
                        }
                    });
                } else {
                    log(`[UI] „ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÉÜ„Çπ„ÉàÂ§±Êïó: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`[UI] „ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÉÜ„Çπ„ÉàÂÆüË°å„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        async function runAllTests() {
            try {
                log('üöÄ ÂÖ®API„ÉÜ„Çπ„ÉàÈñãÂßã...', 'info');
                log('================================================', 'info');
                
                // Server tests
                await runServerTests();
                
                // Wait a bit
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Client tests
                await runClientTests();
                
                log('================================================', 'info');
                log('üéâ ÂÖ®API„ÉÜ„Çπ„ÉàÂÆå‰∫Ü!', 'success');
                
            } catch (error) {
                log(`‚ùå ÂÖ®API„ÉÜ„Çπ„ÉàÂÆüË°å„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        // =============================================================================
        // Event Handlers
        // =============================================================================

        // Event handlers for receiving events from other layers
        window.onServerToUI = function(payload) {
            log(`[UI] „Çµ„Éº„Éê„Éº„Åã„Çâ„Ç§„Éô„É≥„ÉàÂèó‰ø°: ${JSON.stringify(payload, null, 2)}`, 'info');
            return {
                received: true,
                processedBy: "ui",
                timestamp: new Date().toISOString()
            };
        };

        window.onClientToUI = function(payload) {
            log(`[UI] „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Åã„Çâ„Ç§„Éô„É≥„ÉàÂèó‰ø°: ${JSON.stringify(payload, null, 2)}`, 'info');
            return {
                received: true,
                processedBy: "ui",
                timestamp: new Date().toISOString()
            };
        };

        window.onTestEvent = function(payload) {
            log(`[UI] „ÉÜ„Çπ„Éà„Ç§„Éô„É≥„ÉàÂèó‰ø°: ${JSON.stringify(payload, null, 2)}`, 'info');
            return {
                received: true,
                processedBy: "ui",
                timestamp: new Date().toISOString()
            };
        };

        window.onActivityReceived = function(payload) {
            log(`[UI] ActivityPub„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£Âèó‰ø°: ${payload.type} from ${payload.actor}`, 'info');
            return {
                received: true,
                processedBy: "ui",
                timestamp: new Date().toISOString()
            };
        };

        // Initialize
        log('üêô Takos API Test Extension UI ÂàùÊúüÂåñÂÆå‰∫Ü', 'success');
        log(`ÁèæÂú®ÊôÇÂàª: ${new Date().toISOString()}`, 'info');
        log('„ÉÜ„Çπ„Éà„ÇíÈñãÂßã„Åô„Çã„Å´„ÅØ‰∏äË®ò„ÅÆ„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'info');
        // ÊôÇÂàªÊõ¥Êñ∞„ÅÆÈñãÂßã
        setInterval(updateTime, 1000);
        updateTime();
    </script>
</body>
</html>
