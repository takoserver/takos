<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>API Test</title>
    <style>
      body {
        font-family: sans-serif;
        background: #fff;
        color: #333;
      }
      section { margin-bottom: 1rem; }
      button { margin: 2px; }
      #output {
        border: 1px solid #ccc;
        padding: 0.25rem;
        background: #fafafa;
      }
      #output pre {
        margin: 0.25rem 0;
        padding: 0.25rem;
        background: #f4f4f4;
      }
      #output pre.error {
        background: #fee;
        color: #b00;
      }
    </style>
  </head>
  <body>
    <h1>Takopack API Test</h1>
    <section>
      <h2>Server</h2>
      <div id="server"></div>
    </section>
    <section>
      <h2>Client</h2>
      <div id="client"></div>
    </section>
    <section>
      <h2>UI</h2>
      <div id="ui"></div>
    </section>
    <section>
      <h2>Results</h2>
      <div id="output"></div>
    </section>
    <script>
      const serverTests = [
        'serverKv',
        'serverCdn',
        'serverEvents',
        'serverActivityPub',
        'serverExtensions',
        'serverFetch'
      ];
      const clientTests = [
        'clientKv',
        'clientCdn',
        'clientEvents',
        'clientExtensions',
        'clientFetch'
      ];
      const uiTests = [
        'uiKv',
        'uiCdn',
        'uiEvents',
        'uiFetch',
        'uiExtensions',
        'uiUrl'
      ];

      function addButtons(container, tests, runner) {
        tests.forEach(name => {
          const b = document.createElement('button');
          b.textContent = name;
          b.onclick = () => runner(name);
          container.appendChild(b);
        });
      }

      async function runEvent(name) {
        if (typeof takos === 'undefined') return;
        try {
          const res = await takos.events.publish(name, {});
          if (Array.isArray(res)) {
            const [status, body] = res;
            if (status >= 200 && status < 300) {
              print(name, body);
            } else {
              printError(name, body);
            }
          }
        } catch (err) {
          printError(name, err);
        }
      }

      async function runUi(name) {
        try {
          if (name === 'uiKv') {
            await takos.kv.write('ui:test', 'ok');
            const value = await takos.kv.read('ui:test');
            await takos.kv.delete('ui:test');
            print(name, { value });
          } else if (name === 'uiCdn') {
            await takos.cdn.write('ui.txt', 'hello', { cacheTTL: 0 });
            const data = await takos.cdn.read('ui.txt');
            await takos.cdn.delete('ui.txt');
            print(name, { data });
          } else if (name === 'uiEvents') {
            let received = false;
            const u = takos.events.subscribe('uiPing', () => { received = true; });
            await takos.events.publish('uiPing', {});
            u();
            print(name, { received });
          } else if (name === 'uiFetch') {
            const res = await takos.fetch('https://example.com');
            print(name, { ok: res.ok });
          } else if (name === 'uiExtensions') {
            const ext = takos.extensions.get('com.example.api-test');
            const api = await takos.activateExtension('com.example.api-test');
            print(name, { has: !!ext, activated: typeof api?.publish === 'function' });
          } else if (name === 'uiUrl') {
            const before = takos.getURL();
            let changed = false;
            const off = takos.changeURL(() => { changed = true; });
            takos.pushURL('tmp', { showBar: false });
            takos.setURL(before, { showBar: false });
            off();
            print(name, { before, changed, after: takos.getURL() });
          }
        } catch (err) {
          printError(name, err);
        }
      }

      function print(name, res) {
        const out = document.getElementById('output');
        const pre = document.createElement('pre');
        pre.textContent = name + '\n' + JSON.stringify(res, null, 2);
        out.prepend(pre);
      }

      function printError(name, err) {
        const out = document.getElementById('output');
        const pre = document.createElement('pre');
        pre.className = 'error';
        pre.textContent = name + '\n' + String(err);
        out.prepend(pre);
      }

      addButtons(document.getElementById('server'), serverTests, runEvent);
      addButtons(document.getElementById('client'), clientTests, runEvent);
      addButtons(document.getElementById('ui'), uiTests, runUi);
    </script>
  </body>
</html>
