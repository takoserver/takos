<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>API Test</title>
    <style>
      body {
        font-family: sans-serif;
        background: #fff;
        color: #333;
      }
      section {
        margin-bottom: 1rem;
      }
      button {
        margin: 2px;
      }
      #output {
        border: 1px solid #ccc;
        padding: 0.25rem;
      }
      #output pre {
        margin: 0.25rem 0;
        padding: 0.25rem;
        background: #f0f0f0;
      }
      #output pre.error {
        color: #b00020;
        background: #fff0f0;
      }
    </style>
  </head>
  <body>
    <h1>Takopack API Test</h1>
    <section>
      <h2>Server</h2>
      <div id="server"></div>
    </section>
    <section>
      <h2>Client</h2>
      <div id="client"></div>
    </section>
    <section>
      <h2>UI</h2>
      <div id="ui"></div>
    </section>
    <section>
      <h2>Results</h2>
      <div id="output"></div>
    </section>
    <script>
      const serverTests = [
        "serverKv",
        "serverCdn",
        "serverEvents",
        "serverActivityPub",
        "serverExtensions",
        "serverFetch",
        "serverSource",
      ];
      const clientTests = [
        "clientKv",
        "clientEvents",
        "clientExtensions",
        "clientFetch",
        "clientSource",
      ];
      const uiTests = [
        "uiKv",
        "uiEvents",
        "uiFetch",
        "uiExtensions",
        "uiUrl",
      ];

      function addButtons(container, tests, runner) {
        tests.forEach((name) => {
          const b = document.createElement("button");
          b.textContent = name;
          b.onclick = () => runner(name);
          container.appendChild(b);
        });
      }

      async function runEvent(name) {
        if (typeof takos === "undefined") return;
        try {
          const res = await takos.events.publish(name, {});
          if (Array.isArray(res)) {
            const [, body] = res;
            print(name, body);
          }
        } catch (err) {
          print(name, String(err), true);
        }
      }

      async function runUi(name) {
        try {
          if (name === "uiKv") {
            await takos.kv.write("ui:test", "ok");
            const value = await takos.kv.read("ui:test");
            await takos.kv.delete("ui:test");
            print(name, { value });
          } else if (name === "uiEvents") {
            await takos.events.publish("uiPing", {});
            print(name, { ok: true });
          } else if (name === "uiFetch") {
            const res = await takos.fetch("https://example.com");
            print(name, { ok: res.ok });
          } else if (name === "uiExtensions") {
            const ext = takos.extensions.get("com.example.api-test");
            const api = await takos.activateExtension(
              "com.example.api-test",
            );
            print(name, {
              has: !!ext,
              activated: typeof api?.publish === "function",
            });
          } else if (name === "uiUrl") {
            const before = takos.getURL();
            let changed = false;
            const off = takos.changeURL(() => {
              changed = true;
            });
            takos.pushURL("tmp", { showBar: false });
            takos.setURL(before, { showBar: false });
            off();
            print(name, { before, changed, after: takos.getURL() });
          }
        } catch (err) {
          print(name, String(err), true);
        }
      }

      function print(name, res, error = false) {
        const out = document.getElementById("output");
        const pre = document.createElement("pre");
        if (typeof res === "string") {
          pre.textContent = name + "\n" + res;
        } else {
          pre.textContent = name + "\n" + JSON.stringify(res, null, 2);
        }
        if (error) pre.classList.add("error");
        out.prepend(pre);
      }

      addButtons(
        document.getElementById("server"),
        serverTests,
        runEvent,
      );
      addButtons(
        document.getElementById("client"),
        clientTests,
        runEvent,
      );
      addButtons(document.getElementById("ui"), uiTests, runUi);
    </script>
  </body>
</html>
