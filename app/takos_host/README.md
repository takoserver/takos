# takos host とは

takos host は takos
サーバーをレンタル形式で提供するためのホスティングソフトウェアです。ユーザーは
takos host 上でアカウントを作成し、ブラウザから takos
サーバーを借りてすぐに利用を開始できます。必要に応じてパスワードを設定できますが、基本的には
OAuth
でログインします。サーバーを貸与することで、アルゴリズムや著作権などの権利を利用者へ移譲し、誰でも自由に
takos を運用できるようにすることが目的です。

## 仕組み

1. takos host にアカウントを登録し、ユーザー画面から新しい takos
   サーバーを作成します。
2. サーバーごとに専用のドメインを割り当てたように見せかけますが、実際には 単一の
   Deno スクリプトで複数インスタンスを模倣します。
   個別のプロセスを起動・停止するわけではなく、takos と同等の API を共通
   ロジックとして取り込むことで、多数のサーバーが動作しているかのように振る舞う
   だけの構成です。
3. 各インスタンスはデフォルトで takos.jp
   のリレーに参加しており、内部的にはリレーに近い仕組みを inbox
   を介さずに実装します。リレー先は `ROOT_DOMAIN` で指定したドメインになります。
4. ユーザーは発行されたドメインへアクセスし、OAuth
   認証でログインします。パスワードを設定した場合は `/login`
   からログインできます。

ホスト側ではドメイン名を基にインスタンスを識別し、takos の API
を共通モジュールとして読み込んで処理します。これにより複数の takos
サーバーを一元管理できます。

環境変数 `ROOT_DOMAIN` を設定すると、インスタンスのホスト名は
`<サブドメイン>.<ROOT_DOMAIN>` の形式で自動補完されます。`FREE_PLAN_LIMIT`
で1ユーザーが作成できる無料インスタンス数を制限できます。
現在はサブドメインのみ利用可能で、独自ドメイン機能は未実装です。takos host
から個別に環境変数を編集する機能はありません。

## ログインとユーザー API

`ROOT_DOMAIN` で指定したドメインへアクセスすると、ウェルカムページが
表示されます。ログインは `/auth`、ダッシュボードは `/user` から利用します。
`/auth` では登録やログインなど API も提供され、取得したセッション Cookie
を送信することで `/user` 以下の API を利用できます。

- `POST /auth/register` 新規ユーザー登録
- `POST /auth/login` ログイン
- `GET /auth/status` セッション状態確認
- `DELETE /auth/logout` ログアウト

ユーザー API では以下のエンドポイントが利用できます。

- `GET /user/instances` 登録済みインスタンス一覧を取得
- `POST /user/instances` 新しいインスタンスを追加 (必要に応じてパスワードも設定)
- `DELETE /user/instances/:host` インスタンスを削除
- `GET /user/instances/:host` インスタンスの情報を取得 (ホスト名のみ)
- `PUT /user/instances/:host/password`
  インスタンスのログインパスワードを設定/変更 (空を送ると無効化)
  _独自ドメイン関連の API は今後実装予定です_

環境変数やパスワードを更新すると、キャッシュされたアプリが破棄され、次のアクセス時に再起動されます。

## フロントエンド

ユーザー画面は Vite と Solid.js で作られています。状態管理には solid-jotai
を用い、ページ間で共通の状態を保持します。 `app/takos_host/client`
で以下を実行すると開発サーバーが起動します。

```bash
$ deno task dev
```

ビルドしたファイルは `client/dist`
に配置され、サーバーから自動的に配信されます。

### インスタンスへのログイン

各インスタンスでは基本的に OAuth を利用してログインします。ログイン画面から
takos host の `/oauth/authorize` へ遷移し、認可後に返される `code` を
インスタンスの `/api/oauth/login` へ送信すると、サーバー側でアクセストークンを
取得してセッションを開始します。インスタンス作成時に必要な OAuth クライアントは
自動登録されますが、追加で登録したい場合は `/user/oauth/clients` を利用してくだ
さい。

パスワードを設定した場合は `/login` へパスワードを POST
してログインできます。`POST /user/instances` で指定したパスワードは
`hashedPassword` と `salt` としてインスタンスの環境変数に保存されます。 OAuth
認証は常にホストの `ROOT_DOMAIN` を利用します。 インスタンスでは `/api/config`
にアクセスすることで `OAUTH_HOST` を取得でき、 ログイン画面は値が存在する場合に
OAuth ボタンを表示します。

## 起動方法

1. `.env.example` を参考に `.env` を作成します。
   - `ROOT_DOMAIN` にホストの基本ドメインを設定します。
   - `FREE_PLAN_LIMIT` で無料プランのインスタンス数上限を指定します。
2. `deno run -A app/takos_host/main.ts` でサーバーを起動します。
