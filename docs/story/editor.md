# ストーリーエディタ設計

本書では Solid.js で実装する簡易ストーリーエディタの設計方針をまとめる。
画像または動画を読み込み、縦向きのキャンバス上でオーバーレイを配置する。
読み込んだメディア自体もドラッグで移動できる。画像のみの場合は PNG を生成し、
動画が含まれる場合は **ffmpeg.wasm** を用いてテキストオーバーレイを各フレームへ
合成した MP4 を作成する。配置情報は `x:overlays` として保存する。

## 機能概要

1. 画像または動画をアップロード（URL 指定も可）
2. 動画は **ffmpeg.wasm**
   で読み込み、先頭フレームを抽出して編集用キャンバスに表示
   したのち、キャンバス上でドラッグして配置を変更できる
3. メンション・質問箱・任意テキストの位置を編集 UI
   で指定し、ドラッグで移動できる
4. オーバーレイの右下ハンドルをドラッグしてサイズを変更できる。回転は `rotation`
   に角度を保存する
5. `Export` を実行すると画像なら PNG、動画ならテキストオーバーレイを合成した MP4
   を生成
6. `x:overlays` に配置情報を JSON 形式で保存

## オーバーレイデータ形式

`x:overlays` の各要素は以下のフィールドを持つ。

| フィールド | 役割                                         |
| ---------- | -------------------------------------------- |
| `id`       | オーバーレイ識別子                           |
| `kind`     | `mention` `question` など種類を示す文字列    |
| `ref`      | メンション先 Actor など関連オブジェクトの ID |
| `text`     | 表示する文字列（テキストオーバーレイの場合） |
| `bbox`     | `[x,y,w,h]` (0〜1 正規化) 配置とサイズ       |
| `rotation` | 回転角度 (度数、任意)                        |

## UI 操作

1. メディア選択後、`<canvas>` に読み込んだメディアを描画する。動画の場合は
   **ffmpeg.wasm** で先頭フレームを抽出して表示し、キャンバス上でドラッグして
   位置を調整できる。
2. 追加ボタンからメンション／質問箱／テキストを選択すると編集レイヤが生成され、ドラッグで位置を変更できる。テキストはその場で編集可能。右下のハンドルをドラッグするとサイズを変更でき、Ctrl+ドラッグで回転できる。
3. 完了後、`Export` を押すと画像の場合は PNG、動画の場合はテキストオーバーレイを
   合成した MP4 と `x:overlays` 配列を返す。

これにより未対応クライアントでも元画像を表示しつつ、対応実装では質問やメンション等の機能を提供できる。
