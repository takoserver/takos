# 🐙 Takos 拡張機能仕様書 v3

> **仕様バージョン**: v3.0 (ドラフト) **最終更新**: 2025-06-11

## 🎯 目次

1. [目的](#目的)
2. [用語](#用語)
3. [パッケージ構造](#パッケージ構造)
4. [manifest.json 詳細仕様](#manifestjson-詳細仕様)
5. [名前空間と衝突回避](#名前空間と衝突回避)
6. [API 仕様](./api.md)
7. [v2.1からの移行ガイド](#v21からの移行ガイド)
8. [Sandbox 実行環境](#sandbox-実行環境)

---

## 目的

Takos を VSCode ライクに安全かつ柔軟に拡張するための共通仕様を定義します。拡張は
**server.js**、**client.js**、**index.html** の 3 ファイルで完結し、Deno
互換環境上で実行されます。

---

## 用語

| 用語                  | 説明                                                       |
| --------------------- | ---------------------------------------------------------- |
| Pack (.takopack)      | zip 形式の拡張パッケージ。トップに `takos/` フォルダを持つ |
| Identifier            | `com.example.foo` のような逆 FQDN。`takos` は予約済み      |
| Permission            | `resource:action(:scope)` 形式の権限文字列                 |
| ExtensionDependencies | 他拡張への依存定義                                         |
| Exports               | 外部公開 API の一覧                                        |

---

## パッケージ構造

```
awesome-pack.takopack
└─ takos/
   ├─ manifest.json  # 必須
   ├─ server.js      # サーバー
   ├─ client.js      # バックグラウンド
   └─ index.html     # UI
```

`server.js` と `client.js` は依存のない単一ファイルです。`index.html` は UI
を提供します。`/api/extensions/<id>/ui` で読み込むと `client.js`
も自動でロードされます。

---

## manifest.json 詳細仕様

`manifest.json` は [manifest.schema.json](./manifest.schema.json)
で検証できます。主なフィールドは次のとおりです。

```jsonc
{
  "name": "awesome-pack",
  "description": "拡張機能の説明",
  "version": "1.2.0",
  "identifier": "com.example.awesome",
  "icon": "./icon.png",
  "apiVersion": "3.0",

  "extensionDependencies": [
    { "identifier": "com.example.lib", "version": "^1.0.0" }
  ],

  "exports": ["postMessage", "notifyClient"],

  "permissions": [
    "fetch:net",
    "activitypub:send",
    "activitypub:read",
    "activitypub:receive:hook",
    "activitypub:actor:read",
    "activitypub:actor:write",
    "plugin-actor:create",
    "plugin-actor:read",
    "plugin-actor:write",
    "plugin-actor:delete",
    "kv:read",
    "kv:write",
    "cdn:read",
    "cdn:write",
    "extensions:invoke",
    "extensions:export",
    // denoの権限は特権的な操作を制限するために必要です
    // 基本的に要求しませんが、必要な場合は追加してください
    "deno:read",
    "deno:write",
    "deno:net",
    "deno:env",
    "deno:run",
    "deno:sys",
    "deno:ffi"
  ],

  "server": { "entry": "./server.js" },
  "client": {
    "entryUI": "./index.html",
    "entryBackground": "./client.js"
  },

  "activityPub": {
    "objects": ["Note", "Create", "Like"],
    "hook": "onReceive"
  }
}
```

---

## 名前空間と衝突回避

- Identifier は逆 FQDN 形式を採用し衝突を避けます。
- KV とアセットは `identifier` 毎に名前空間分離されます。
  - KV: `${identifier}:${key}`
  - CDN: `${identifier}/${path}`
- 同名関数を export しても識別子ごとに独立するため衝突しません。
- 依存解決は npm-semver 準拠で最新版優先、警告あり。

---

詳しい API 仕様は [api.md](./api.md) を参照してください。
## v2.1からの移行ガイド

1. 権限宣言を `manifest.permissions` に集約。
2. manifest から `eventDefinitions` を削除し、`takos.events.onRequest()`
   でハンドラー登録。
3. ActivityPub API は `activityPub()` に統合。
4. `extensionDependencies` と `exports` を利用し、`takos.extensions` API
   で他拡張と連携。

---

## Sandbox 実行環境

- すべてのレイヤーはサンドボックスで分離されます。
- `activate()` の戻り値は structuredClone 準拠でシリアライズ。
- 呼び出し権限は export 元の範囲に限定され、依存循環はエラーとなります。

---

