# ğŸ™ Takos æ‹¡å¼µæ©Ÿèƒ½ä»•æ§˜æ›¸ v3

> **ä»•æ§˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v3.0 (ãƒ‰ãƒ©ãƒ•ãƒˆ) **æœ€çµ‚æ›´æ–°**: 2025-06-11

## ğŸ¯ ç›®æ¬¡
1. [ç›®çš„](#ç›®çš„)
2. [ç”¨èª](#ç”¨èª)
3. [ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ§‹é€ ](#ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ§‹é€ )
4. [manifest.json è©³ç´°ä»•æ§˜](#manifestjson-è©³ç´°ä»•æ§˜)
5. [åå‰ç©ºé–“ã¨è¡çªå›é¿](#åå‰ç©ºé–“ã¨è¡çªå›é¿)
6. [APIã¨æ¨©é™](#apiã¨æ¨©é™)
7. [globalThis.takos API](#globalthistakos-api)
8. [ActivityPub ãƒ•ãƒƒã‚¯](#activitypub-ãƒ•ãƒƒã‚¯)
9. [ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©](#ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©)
10. [v2.1ã‹ã‚‰ã®ç§»è¡Œã‚¬ã‚¤ãƒ‰](#v21ã‹ã‚‰ã®ç§»è¡Œã‚¬ã‚¤ãƒ‰)
11. [Sandbox å®Ÿè¡Œç’°å¢ƒ](#sandbox-å®Ÿè¡Œç’°å¢ƒ)
12. [æ‹¡å¼µæ©Ÿèƒ½é–“APIé€£æº](#æ‹¡å¼µæ©Ÿèƒ½é–“apié€£æº)

---

## ç›®çš„

Takos ã‚’ VSCode ãƒ©ã‚¤ã‚¯ã«å®‰å…¨ã‹ã¤æŸ”è»Ÿã«æ‹¡å¼µã™ã‚‹ãŸã‚ã®å…±é€šä»•æ§˜ã‚’å®šç¾©ã—ã¾ã™ã€‚æ‹¡å¼µã¯ **server.js**ã€**client.js**ã€**index.html** ã® 3 ãƒ•ã‚¡ã‚¤ãƒ«ã§å®Œçµã—ã€Deno äº’æ›ç’°å¢ƒä¸Šã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

---

## ç”¨èª

| ç”¨èª | èª¬æ˜ |
| ---- | ---- |
| Pack (.takopack) | zip å½¢å¼ã®æ‹¡å¼µãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€‚ãƒˆãƒƒãƒ—ã« `takos/` ãƒ•ã‚©ãƒ«ãƒ€ã‚’æŒã¤ |
| Identifier | `com.example.foo` ã®ã‚ˆã†ãªé€† FQDNã€‚`takos` ã¯äºˆç´„æ¸ˆã¿ |
| Permission | `resource:action(:scope)` å½¢å¼ã®æ¨©é™æ–‡å­—åˆ— |
| ExtensionDependencies | ä»–æ‹¡å¼µã¸ã®ä¾å­˜å®šç¾© |
| Exports | å¤–éƒ¨å…¬é–‹ API ã®ä¸€è¦§ |

---

## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ§‹é€ 

```
awesome-pack.takopack
â””â”€ takos/
   â”œâ”€ manifest.json  # å¿…é ˆ
   â”œâ”€ server.js      # ã‚µãƒ¼ãƒãƒ¼
   â”œâ”€ client.js      # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰
   â””â”€ index.html     # UI
```

`server.js` ã¨ `client.js` ã¯ä¾å­˜ã®ãªã„å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚`index.html` ã¯ UI ã‚’æä¾›ã—ã¾ã™ã€‚

---

## manifest.json è©³ç´°ä»•æ§˜

`manifest.json` ã¯ [manifest.schema.json](./manifest.schema.json) ã§æ¤œè¨¼ã§ãã¾ã™ã€‚ä¸»ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

```jsonc
{
  "name": "awesome-pack",
  "description": "æ‹¡å¼µæ©Ÿèƒ½ã®èª¬æ˜",
  "version": "1.2.0",
  "identifier": "com.example.awesome",
  "icon": "./icon.png",
  "apiVersion": "3.0",

  "extensionDependencies": [
    { "identifier": "com.example.lib", "version": "^1.0.0" }
  ],

  "exports": {
    "server": ["calculateHash", "sign"],
    "background": [],
    "ui": []
  },

  "permissions": [
    "fetch:net",
    "activitypub:send",
    "activitypub:read",
    "activitypub:receive:hook",
    "activitypub:actor:read",
    "activitypub:actor:write",
    "plugin-actor:create",
    "plugin-actor:read",
    "plugin-actor:write",
    "plugin-actor:delete",
    "kv:read",
    "kv:write",
    "cdn:read",
    "cdn:write",
    "events:publish",
    "events:subscribe",
    "extensions:invoke",
    "extensions:export",
    "deno:read",
    "deno:write",
    "deno:net",
    "deno:env",
    "deno:run",
    "deno:sys",
    "deno:ffi"
  ],

  "server": { "entry": "./server.js" },
  "client": {
    "entryUI": "./index.html",
    "entryBackground": "./client.js"
  },

  "activityPub": {
    "objects": [{
      "accepts": ["Note", "Create", "Like"],
      "context": "https://www.w3.org/ns/activitystreams",
      "hooks": {
        "canAccept": "canAccept",
        "onReceive": "onReceive",
        "priority": 1,
        "serial": false
      }
    }]
  },

  "eventDefinitions": {
    "postMessage": {
      "source": "client",
      "handler": "onPostMessage"
    },
    "notifyClient": {
      "source": "server",
      "handler": "onNotifyClient"
    }
  }
}
```

---

## åå‰ç©ºé–“ã¨è¡çªå›é¿

- Identifier ã¯é€† FQDN å½¢å¼ã‚’æ¡ç”¨ã—è¡çªã‚’é¿ã‘ã¾ã™ã€‚
- KV ã¨ã‚¢ã‚»ãƒƒãƒˆã¯ `identifier` æ¯ã«åå‰ç©ºé–“åˆ†é›¢ã•ã‚Œã¾ã™ã€‚
  - KV: `${identifier}:${key}`
  - CDN: `${identifier}/${path}`
- åŒåé–¢æ•°ã‚’ export ã—ã¦ã‚‚è­˜åˆ¥å­ã”ã¨ã«ç‹¬ç«‹ã™ã‚‹ãŸã‚è¡çªã—ã¾ã›ã‚“ã€‚
- ä¾å­˜è§£æ±ºã¯ npm-semver æº–æ‹ ã§æœ€æ–°ç‰ˆå„ªå…ˆã€è­¦å‘Šã‚ã‚Šã€‚

---

## APIã¨æ¨©é™

ä¸»è¦ API ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚·ã‚°ãƒãƒãƒ£ã¨å¿…è¦æ¨©é™ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

### ActivityPub

#### ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ“ä½œ
- **send**: `takos.activitypub.send(userId: string, activity: object): Promise<void>`
  - **å¿…è¦æ¨©é™**: `activitypub:send`
- **read**: `takos.activitypub.read(id: string): Promise<object>`
  - **å¿…è¦æ¨©é™**: `activitypub:read`
- **delete**: `takos.activitypub.delete(id: string): Promise<void>`
  - **å¿…è¦æ¨©é™**: `activitypub:send`
- **list**: `takos.activitypub.list(userId?: string): Promise<string[]>`
  - **å¿…è¦æ¨©é™**: `activitypub:read`

#### ãƒ•ãƒƒã‚¯å‡¦ç†
- ActivityPub ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå—ä¿¡æ™‚ã®ãƒ•ãƒƒã‚¯ (`canAccept`, `onReceive`)
  - **å¿…è¦æ¨©é™**: `activitypub:receive:hook`

#### ã‚¢ã‚¯ã‚¿ãƒ¼æ“ä½œ
- **read**: `takos.activitypub.actor.read(userId: string): Promise<object>`
- **update**: `takos.activitypub.actor.update(userId: string, key: string, value: string): Promise<void>`
- **delete**: `takos.activitypub.actor.delete(userId: string, key: string): Promise<void>`
- **follow**: `takos.activitypub.follow(followerId: string, followeeId: string): Promise<void>`
- **unfollow**: `takos.activitypub.unfollow(followerId: string, followeeId: string): Promise<void>`
- **listFollowers**: `takos.activitypub.listFollowers(actorId: string): Promise<string[]>`
- **listFollowing**: `takos.activitypub.listFollowing(actorId: string): Promise<string[]>`
  - **å¿…è¦æ¨©é™**: `activitypub:actor:read` / `activitypub:actor:write`

### ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¢ã‚¯ã‚¿ãƒ¼æ“ä½œ
- **create**: `takos.activitypub.pluginActor.create(localName: string, profile: object): Promise<string>`
- **read**: `takos.activitypub.pluginActor.read(iri: string): Promise<object>`
- **update**: `takos.activitypub.pluginActor.update(iri: string, partial: object): Promise<void>`
- **delete**: `takos.activitypub.pluginActor.delete(iri: string): Promise<void>`
- **list**: `takos.activitypub.pluginActor.list(): Promise<string[]>`
  - **å¿…è¦æ¨©é™**: `plugin-actor:create` / `plugin-actor:read` / `plugin-actor:write` / `plugin-actor:delete`

### kv
- **read**: `takos.kv.read(key: string): Promise<any>`
- **write**: `takos.kv.write(key: string, value: any): Promise<void>`
- **delete**: `takos.kv.delete(key: string): Promise<void>`
- **list**: `takos.kv.list(): Promise<string[]>`
  - **å¿…è¦æ¨©é™**: `kv:read` / `kv:write`
  - `server.js` ã¨ `client.js` / `index.html` ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¯ç‹¬ç«‹

### fetch
- **fetch**: `takos.fetch(url: string, options?: object): Promise<Response>`
  - **å¿…è¦æ¨©é™**: `fetch:net`  (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã¯ `client.allowedConnectSrc` è¨­å®šãŒå¿…è¦)

### cdn
- **read**: `takos.cdn.read(path: string): Promise<string>`
- **write**: `takos.cdn.write(path: string, data: string | Uint8Array, options?: { cacheTTL?: number }): Promise<string>`
- **delete**: `takos.cdn.delete(path: string): Promise<void>`
- **list**: `takos.cdn.list(prefix?: string): Promise<string[]>`
  - **å¿…è¦æ¨©é™**: `cdn:read` / `cdn:write`
  - **åˆ¶é™**: åˆè¨ˆ 20MB ã¾ã§ã€‚ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ `/cdn/<identifier>/<path>`

### events
ã‚¤ãƒ™ãƒ³ãƒˆã¯ manifest.json ã® `eventDefinitions` ã§å®£è¨€ã—ã¾ã™ã€‚å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ (server, client, background, ui) ã‹ã‚‰ã¯åŒã˜ API ã§å®Ÿè¡Œã§ãã¾ã™ã€‚

- `takos.events.publish(eventName: string, payload: any): Promise<[number, object]> | Promise<void>`
  - é€ä¿¡å…ˆãŒ `server` ã®å ´åˆã€ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒè¿”ã™ `[status, body]` ã‚’å–å¾—ã—ã¾ã™ã€‚ãã®ä»–ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼å‘ã‘ã¯ `void` ã‚’è¿”ã—ã¾ã™ã€‚
- `takos.events.subscribe(eventName: string, handler: (payload: any) => void): () => void`
  - **å¿…è¦æ¨©é™**: `events:publish` / `events:subscribe`
  - **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: 10 ä»¶/ç§’

### æ‹¡å¼µé–“ API
- `takos.extensions.get(identifier: string): Extension | undefined`
- `Extension.activate(): Promise<any>`
  - **å¿…è¦æ¨©é™**: `extensions:invoke` / `extensions:export`

æ¨©é™ã¯ã™ã¹ã¦ `manifest.permissions` ã«åˆ—æŒ™ã—ã€å¿…è¦æœ€ä½é™ã‚’å®£è¨€ã—ã¦ãã ã•ã„ã€‚

---

## globalThis.takos API

Takos ã®å„ API ã¯ `globalThis` ä¸Šã® `takos` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦å…¬é–‹ã•ã‚Œã¾ã™ã€‚
ãã®ãŸã‚ã€å„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å†’é ­ã§æ¬¡ã®ã‚ˆã†ã«å–å¾—ã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚

```javascript
const { takos } = globalThis;
```

```typescript
namespace takos.extensions {
  function get(identifier: string): Extension | undefined;
  const all: Extension[];
}
interface Extension {
  identifier: string;
  version: string;
  isActive: boolean;
  activate(): Promise<any>;
}
```

åˆ©ç”¨ä¾‹:

```javascript
const ext = takos.extensions.get("com.example.lib");
if (ext) {
  const api = await ext.activate();
  const hash = await api.calculateHash("hello");
}
```

ãã®ä»–ã® API ã‚‚ `takos.*` åå‰ç©ºé–“ã«é›†ç´„ã•ã‚Œã¦ã„ã¾ã™ã€‚

---

## ActivityPub ãƒ•ãƒƒã‚¯

`activityPub.objects.accepts` ã«æŒ‡å®šã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å—ä¿¡ã™ã‚‹ã¨ã€å„ Pack ã® `canAccept` â†’ `onReceive` ãŒé †ã«å‘¼ã°ã‚Œã¾ã™ã€‚`serial: true` ã‚’æŒ‡å®šã™ã‚‹ã¨å„ªå…ˆåº¦é †ã«é€æ¬¡å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```javascript
const afterA = await PackA.onReceive(obj);
const afterB = await PackB.onReceive(afterA);
```

---

## ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©

`eventDefinitions` ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’å®£è¨€ã—ã€`server.js` ç­‰ã§ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```jsonc
{
  "eventDefinitions": {
    "myEvent": {
      "source": "client",
      "handler": "onMyEvent"
    }
  }
}
```

- é€ä¿¡å…ƒã¯ `client`ã€`server`ã€`background`ã€`ui` ã®ã„ãšã‚Œã‹
- å¯¾è±¡ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®Ÿè£…ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã§æ±ºã¾ã‚Šã¾ã™

ã‚µãƒ¼ãƒãƒ¼å´ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¯ `[200|400|500, body]` ã‚’è¿”ã—ã¾ã™ã€‚

å®šç¾©ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã¯ã€ã©ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ã‚‚å…±é€šã® `takos.events.publish(eventName, payload)` ã§ç™ºè¡Œã§ãã¾ã™ã€‚

---

## v2.1ã‹ã‚‰ã®ç§»è¡Œã‚¬ã‚¤ãƒ‰

1. æ¨©é™å®£è¨€ã‚’ `manifest.permissions` ã«é›†ç´„ã€‚
2. ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©ã¯ `source` ã®ã¿ã‚’æŒ‡å®šã—ã€ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®Ÿè£…å´ãŒå—ä¿¡å…ˆã¨ãªã‚Šã¾ã™ã€‚
3. ActivityPub API ã¯ `activityPub()` ã«çµ±åˆã€‚
4. `extensionDependencies` ã¨ `exports` ã‚’åˆ©ç”¨ã—ã€`takos.extensions` API ã§ä»–æ‹¡å¼µã¨é€£æºã€‚

---

## Sandbox å®Ÿè¡Œç’°å¢ƒ

- ã™ã¹ã¦ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã§åˆ†é›¢ã•ã‚Œã¾ã™ã€‚
- `activate()` ã®æˆ»ã‚Šå€¤ã¯ structuredClone æº–æ‹ ã§ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã€‚
- å‘¼ã³å‡ºã—æ¨©é™ã¯ export å…ƒã®ç¯„å›²ã«é™å®šã•ã‚Œã€ä¾å­˜å¾ªç’°ã¯ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚

---

## æ‹¡å¼µæ©Ÿèƒ½é–“APIé€£æº

### è¨˜è¿°æ–¹æ³•
- `extensionDependencies` ã§ä¾å­˜ Pack ã‚’å®£è¨€ã—ã€æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã¯ UI ã§é€šçŸ¥ã€‚
- `exports` ã§å…¬é–‹é–¢æ•°ã‚’ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã«åˆ—æŒ™ã—ã¾ã™ã€‚

### æ¨©é™åˆ¶å¾¡
- `extensions:export` ä»–æ‹¡å¼µã¸ API ã‚’å…¬é–‹ã™ã‚‹æ¨©é™ã€‚
- `extensions:invoke` ä»–æ‹¡å¼µã® API ã‚’å–å¾—ã™ã‚‹æ¨©é™ã€‚

### åˆ©ç”¨æ–¹æ³•

```javascript
const ext = takos.extensions.get("com.example.lib");
if (ext) {
  const api = await ext.activate();
  await api.doSomething();
}
```

TypeScript ã§å‹å®‰å…¨ã«é€£æºã§ãã€npm-semver æº–æ‹ ã§ä¾å­˜è§£æ±ºã•ã‚Œã¾ã™ã€‚

---
