# ğŸ™ Takos æ‹¡å¼µæ©Ÿèƒ½ä»•æ§˜æ›¸ v3

> **ä»•æ§˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v3.0 (ãƒ‰ãƒ©ãƒ•ãƒˆ) **æœ€çµ‚æ›´æ–°**: 2025-06-11

## ğŸ¯ ç›®æ¬¡

1. [ç›®çš„](#ç›®çš„)
2. [ç”¨èª](#ç”¨èª)
3. [ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ§‹é€ ](#ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ§‹é€ )
4. [manifest.json è©³ç´°ä»•æ§˜](#manifestjson-è©³ç´°ä»•æ§˜)
5. [åå‰ç©ºé–“ã¨è¡çªå›é¿](#åå‰ç©ºé–“ã¨è¡çªå›é¿)
6. [APIã¨æ¨©é™](#apiã¨æ¨©é™)
7. [globalThis.takos API](#globalthistakos-api)
8. [ActivityPub ãƒ•ãƒƒã‚¯](#activitypub-ãƒ•ãƒƒã‚¯)
9. [ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©](#ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©)
10. [v2.1ã‹ã‚‰ã®ç§»è¡Œã‚¬ã‚¤ãƒ‰](#v21ã‹ã‚‰ã®ç§»è¡Œã‚¬ã‚¤ãƒ‰)
11. [Sandbox å®Ÿè¡Œç’°å¢ƒ](#sandbox-å®Ÿè¡Œç’°å¢ƒ)
12. [æ‹¡å¼µæ©Ÿèƒ½é–“APIé€£æº](#æ‹¡å¼µæ©Ÿèƒ½é–“apié€£æº)
13. [UI URLæ“ä½œ](#ui-urlæ“ä½œ)

---

## ç›®çš„

Takos ã‚’ VSCode ãƒ©ã‚¤ã‚¯ã«å®‰å…¨ã‹ã¤æŸ”è»Ÿã«æ‹¡å¼µã™ã‚‹ãŸã‚ã®å…±é€šä»•æ§˜ã‚’å®šç¾©ã—ã¾ã™ã€‚æ‹¡å¼µã¯
**server.js**ã€**client.js**ã€**index.html** ã® 3 ãƒ•ã‚¡ã‚¤ãƒ«ã§å®Œçµã—ã€Deno
äº’æ›ç’°å¢ƒä¸Šã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

---

## ç”¨èª

| ç”¨èª                  | èª¬æ˜                                                       |
| --------------------- | ---------------------------------------------------------- |
| Pack (.takopack)      | zip å½¢å¼ã®æ‹¡å¼µãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã€‚ãƒˆãƒƒãƒ—ã« `takos/` ãƒ•ã‚©ãƒ«ãƒ€ã‚’æŒã¤ |
| Identifier            | `com.example.foo` ã®ã‚ˆã†ãªé€† FQDNã€‚`takos` ã¯äºˆç´„æ¸ˆã¿      |
| Permission            | `resource:action(:scope)` å½¢å¼ã®æ¨©é™æ–‡å­—åˆ—                 |
| ExtensionDependencies | ä»–æ‹¡å¼µã¸ã®ä¾å­˜å®šç¾©                                         |
| Exports               | å¤–éƒ¨å…¬é–‹ API ã®ä¸€è¦§                                        |

---

## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ§‹é€ 

```
awesome-pack.takopack
â””â”€ takos/
   â”œâ”€ manifest.json  # å¿…é ˆ
   â”œâ”€ server.js      # ã‚µãƒ¼ãƒãƒ¼
   â”œâ”€ client.js      # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰
   â””â”€ index.html     # UI
```

`server.js` ã¨ `client.js` ã¯ä¾å­˜ã®ãªã„å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚`index.html` ã¯ UI
ã‚’æä¾›ã—ã¾ã™ã€‚

---

## manifest.json è©³ç´°ä»•æ§˜

`manifest.json` ã¯ [manifest.schema.json](./manifest.schema.json)
ã§æ¤œè¨¼ã§ãã¾ã™ã€‚ä¸»ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

```jsonc
{
  "name": "awesome-pack",
  "description": "æ‹¡å¼µæ©Ÿèƒ½ã®èª¬æ˜",
  "version": "1.2.0",
  "identifier": "com.example.awesome",
  "icon": "./icon.png",
  "apiVersion": "3.0",

  "extensionDependencies": [
    { "identifier": "com.example.lib", "version": "^1.0.0" }
  ],

  "exports": {
    "server": ["calculateHash", "sign"],
    "background": [],
    "ui": []
  },

  "permissions": [
    "fetch:net",
    "activitypub:send",
    "activitypub:read",
    "activitypub:receive:hook",
    "activitypub:actor:read",
    "activitypub:actor:write",
    "plugin-actor:create",
    "plugin-actor:read",
    "plugin-actor:write",
    "plugin-actor:delete",
    "kv:read",
    "kv:write",
    "cdn:read",
    "cdn:write",
    "events:publish",
    "events:subscribe",
    "extensions:invoke",
    "extensions:export",
    // denoã®æ¨©é™ã¯ç‰¹æ¨©çš„ãªæ“ä½œã‚’åˆ¶é™ã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™
    // åŸºæœ¬çš„ã«è¦æ±‚ã—ã¾ã›ã‚“ãŒã€å¿…è¦ãªå ´åˆã¯è¿½åŠ ã—ã¦ãã ã•ã„
    "deno:read",
    "deno:write",
    "deno:net",
    "deno:env",
    "deno:run",
    "deno:sys",
    "deno:ffi"
  ],

  "server": { "entry": "./server.js" },
  "client": {
    "entryUI": "./index.html",
    "entryBackground": "./client.js"
  },

  "activityPub": {
    "objects": [{
      "accepts": ["Note", "Create", "Like"],
      "context": "https://www.w3.org/ns/activitystreams",
      "hooks": {
        "canAccept": "canAccept",
        "onReceive": "onReceive",
        "priority": 1,
        "serial": false
      }
    }]
  },

  "eventDefinitions": {
    "postMessage": {
      "source": "client",
      "handler": "onPostMessage"
    },
    "notifyClient": {
      "source": "server",
      "handler": "onNotifyClient"
    }
  }
}
```

---

## åå‰ç©ºé–“ã¨è¡çªå›é¿

- Identifier ã¯é€† FQDN å½¢å¼ã‚’æ¡ç”¨ã—è¡çªã‚’é¿ã‘ã¾ã™ã€‚
- KV ã¨ã‚¢ã‚»ãƒƒãƒˆã¯ `identifier` æ¯ã«åå‰ç©ºé–“åˆ†é›¢ã•ã‚Œã¾ã™ã€‚
  - KV: `${identifier}:${key}`
  - CDN: `${identifier}/${path}`
- åŒåé–¢æ•°ã‚’ export ã—ã¦ã‚‚è­˜åˆ¥å­ã”ã¨ã«ç‹¬ç«‹ã™ã‚‹ãŸã‚è¡çªã—ã¾ã›ã‚“ã€‚
- ä¾å­˜è§£æ±ºã¯ npm-semver æº–æ‹ ã§æœ€æ–°ç‰ˆå„ªå…ˆã€è­¦å‘Šã‚ã‚Šã€‚

---

## APIã¨æ¨©é™

ä¸»è¦ API ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚·ã‚°ãƒãƒãƒ£ã¨å¿…è¦æ¨©é™ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

### ActivityPub

#### ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ“ä½œ

- **send**: `takos.ap.send(userId: string, activity: object): Promise<void>`
  - **å¿…è¦æ¨©é™**: `activitypub:send`
- **read**: `takos.ap.read(id: string): Promise<object>`
  - **å¿…è¦æ¨©é™**: `activitypub:read`
- **delete**: `takos.ap.delete(id: string): Promise<void>`
  - **å¿…è¦æ¨©é™**: `activitypub:send`
- **list**: `takos.ap.list(userId?: string): Promise<string[]>`
  - **å¿…è¦æ¨©é™**: `activitypub:read`
  - **åˆ©ç”¨å¯èƒ½ãƒ¬ã‚¤ãƒ¤ãƒ¼**: `server` ã®ã¿

#### ãƒ•ãƒƒã‚¯å‡¦ç†

- ActivityPub ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå—ä¿¡æ™‚ã®ãƒ•ãƒƒã‚¯ (`canAccept`, `onReceive`)
  - **å¿…è¦æ¨©é™**: `activitypub:receive:hook`

#### ã‚¢ã‚¯ã‚¿ãƒ¼æ“ä½œ

- **read**: `takos.ap.actor.read(userId: string): Promise<object>`
- **update**:
  `takos.ap.actor.update(userId: string, key: string, value: string): Promise<void>`
- **delete**:
  `takos.ap.actor.delete(userId: string, key: string): Promise<void>`
- **follow**:
  `takos.ap.follow(followerId: string, followeeId: string): Promise<void>`
- **unfollow**:
  `takos.ap.unfollow(followerId: string, followeeId: string): Promise<void>`
- **listFollowers**:
  `takos.ap.listFollowers(actorId: string): Promise<string[]>`
- **listFollowing**:
  `takos.ap.listFollowing(actorId: string): Promise<string[]>`
  - **å¿…è¦æ¨©é™**: `activitypub:actor:read` / `activitypub:actor:write`

### ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¢ã‚¯ã‚¿ãƒ¼æ“ä½œ

- **create**:
  `takos.ap.pluginActor.create(localName: string, profile: object): Promise<string>`
- **read**: `takos.ap.pluginActor.read(iri: string): Promise<object>`
- **update**:
  `takos.ap.pluginActor.update(iri: string, partial: object): Promise<void>`
- **delete**: `takos.ap.pluginActor.delete(iri: string): Promise<void>`
- **list**: `takos.ap.pluginActor.list(): Promise<string[]>`
  - **å¿…è¦æ¨©é™**: `plugin-actor:create` / `plugin-actor:read` /
    `plugin-actor:write` / `plugin-actor:delete`

### kv

- **read**: `takos.kv.read(key: string): Promise<any>`
- **write**: `takos.kv.write(key: string, value: any): Promise<void>`
- **delete**: `takos.kv.delete(key: string): Promise<void>`
- **list**: `takos.kv.list(): Promise<string[]>`
  - **å¿…è¦æ¨©é™**: `kv:read` / `kv:write`
  - `server.js` ã¨ `client.js` / `index.html` ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¯ç‹¬ç«‹
  - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã¯ãƒ¡ãƒ¢ãƒªä¸Šã®ç°¡æ˜“ã‚¹ãƒˆã‚¢ãŒåˆ©ç”¨ã•ã‚Œã€ã‚µãƒ¼ãƒãƒ¼ã¨ã¯åŒæœŸã•ã‚Œã¾ã›ã‚“

### fetch

- **fetch**: `takos.fetch(url: string, options?: object): Promise<Response>`
  - **å¿…è¦æ¨©é™**: `fetch:net` (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã¯ `client.allowedConnectSrc`
    è¨­å®šãŒå¿…è¦)
  - `deno:net` æ¨©é™ã¯ä¸è¦ã§ã™ã€‚ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å†…ã§ã¯ `fetch()` ãŒè‡ªå‹•çš„ã«
    `takos.fetch()` ã¸ãƒãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚

### cdn

- **read**: `takos.cdn.read(path: string): Promise<string>`
- **write**:
  `takos.cdn.write(path: string, data: string | Uint8Array, options?: { cacheTTL?: number }): Promise<string>`
- **delete**: `takos.cdn.delete(path: string): Promise<void>`
- **list**: `takos.cdn.list(prefix?: string): Promise<string[]>`
  - **å¿…è¦æ¨©é™**: `cdn:read` / `cdn:write`
  - **åˆ¶é™**: åˆè¨ˆ 20MB ã¾ã§ã€‚ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ `/cdn/<identifier>/<path>`
  - **åˆ©ç”¨å¯èƒ½ãƒ¬ã‚¤ãƒ¤ãƒ¼**: `server` ã®ã¿

### events

ã‚¤ãƒ™ãƒ³ãƒˆã¯ manifest.json ã® `eventDefinitions` ã§å®£è¨€ã—ã¾ã™ã€‚å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ (server,
client, background, ui) ã‹ã‚‰ã¯åŒã˜ API ã§å®Ÿè¡Œã§ãã¾ã™ã€‚

- `takos.events.publish(eventName: string, payload: any, options?: { push?: boolean }): Promise<[number, object]> | Promise<void>`
  - é€ä¿¡å…ˆãŒ `server` ã®å ´åˆã€ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒè¿”ã™ `[status, body]`
    ã‚’å–å¾—ã—ã¾ã™ã€‚ãã®ä»–ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼å‘ã‘ã¯ `void` ã‚’è¿”ã—ã¾ã™ã€‚
  - `options.push` ã‚’ `true` ã«ã™ã‚‹ã¨ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚ FCM ãªã©ã®
    Push é€šçŸ¥çµŒç”±ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’é…ä¿¡ã§ãã¾ã™ã€‚
  - ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¯å®£è¨€ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸Šã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

### æ‹¡å¼µé–“ API

- `takos.extensions.get(identifier: string): Extension | undefined`
- `Extension.activate(): Promise<{ publish(name: string, payload?: unknown): Promise<unknown> }>`
- `takos.activateExtension(identifier: string): Promise<{ publish(name: string, payload?: unknown): Promise<unknown> } | undefined>`
  - **å¿…è¦æ¨©é™**: `extensions:invoke` / `extensions:export`

æ¨©é™ã¯ã™ã¹ã¦ `manifest.permissions` ã«åˆ—æŒ™ã—ã€å¿…è¦æœ€ä½é™ã‚’å®£è¨€ã—ã¦ãã ã•ã„ã€‚

---

## globalThis.takos API

Takos ã®å„ API ã¯ `globalThis` ä¸Šã® `takos` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦å…¬é–‹ã•ã‚Œã¾ã™ã€‚
ãã®ãŸã‚ã€å„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å†’é ­ã§æ¬¡ã®ã‚ˆã†ã«å–å¾—ã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚

```javascript
const { takos } = globalThis;
```

### ä¸»ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£

ä¸‹è¡¨ã®ã‚ˆã†ã« `takos` ã«ã¯æ‹¡å¼µæ©Ÿèƒ½é–‹ç™ºå‘ã‘ã® API
ç¾¤ãŒé›†ç´„ã•ã‚Œã¦ã„ã¾ã™ã€‚è©³ç´°ãªãƒ¡ã‚½ãƒƒãƒ‰ã¯[APIã¨æ¨©é™](#apiã¨æ¨©é™)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

| ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£           | å½¹å‰²                                                   |
| -------------------- | ------------------------------------------------------ |
| `ap` / `activitypub` | ActivityPub é€£æºç”¨ã® APIã€‚æŠ•ç¨¿é€ä¿¡ã‚„ã‚¢ã‚¯ã‚¿ãƒ¼æ“ä½œã‚’è¡Œã† |
| `kv`                 | æ‹¡å¼µã”ã¨ã®ã‚­ãƒ¼/å€¤ã‚¹ãƒˆã‚¢æ“ä½œ                            |
| `cdn`                | CDN ã¸ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ»å–å¾—                             |
| `events`             | ãƒ¬ã‚¤ãƒ¤ãƒ¼é–“ã‚¤ãƒ™ãƒ³ãƒˆã®ç™ºè¡Œãƒ»è³¼èª­                         |
| `extensions`         | ä»–æ‹¡å¼µã®å–å¾—ã¨ `activate()` å®Ÿè¡Œ                       |
| `activateExtension`  | ID æŒ‡å®šã§æ‹¡å¼µã® `activate()` ã‚’å®Ÿè¡Œ                    |
| `fetch`              | æ¨©é™åˆ¶å¾¡ä»˜ãã® `fetch` ãƒ©ãƒƒãƒ‘ãƒ¼                        |

```typescript
namespace takos.extensions {
  function get(identifier: string): Extension | undefined;
  const all: Extension[];
}
interface Extension {
  identifier: string;
  version: string;
  isActive: boolean;
  activate(): Promise<{
    publish(name: string, payload?: unknown): Promise<unknown>;
  }>;
}
function activateExtension(
  identifier: string,
): Promise<{ publish(name: string, payload?: unknown): Promise<unknown> }>;
```

åˆ©ç”¨ä¾‹:

```javascript
// å¾“æ¥ã®å–å¾—æ–¹æ³•
const ext = takos.extensions.get("com.example.lib");
if (ext) {
  const api = await ext.activate();
  const hash = await api.publish("calculateHash", "hello");
}

// ç›´æ¥æœ‰åŠ¹åŒ–ã™ã‚‹æ–¹æ³•
const api2 = await takos.activateExtension("com.example.lib");
if (api2) {
  const hash2 = await api2.publish("calculateHash", "world");
}
```

ãã®ä»–ã® API ã‚‚ `takos.*` åå‰ç©ºé–“ã«é›†ç´„ã•ã‚Œã¦ã„ã¾ã™ã€‚ ActivityPub API ã¯
`takos.activitypub` ã®ã»ã‹ã€çŸ­ç¸®å½¢ã® `takos.ap` ã‹ã‚‰ã‚‚åˆ©ç”¨ã§ãã¾ã™ã€‚

### ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥ API åˆ©ç”¨å¯å¦

ä»¥ä¸‹ã®è¡¨ã¯ã€ä¸»è¦ API ã‚’å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰åˆ©ç”¨ã§ãã‚‹ã‹ã‚’ç¤ºã—ã¾ã™ã€‚

| API                                                         | server.js | client.js (background) | index.html (UI) |
| ----------------------------------------------------------- | --------- | ---------------------- | --------------- |
| `fetch`                                                     | âœ“         | âœ“                      | âœ“               |
| `kv`                                                        | âœ“         | âœ“                      | âœ“               |
| `cdn`                                                       | âœ“         | â€•                      | â€•               |
| `events`                                                    | âœ“         | âœ“                      | âœ“               |
| `activitypub`                                               | âœ“         | â€•                      | â€•               |
| `extensions` / `activateExtension`                          | âœ“         | âœ“                      | âœ“               |
| UI URL helpers (`getURL`, `pushURL`, `setURL`, `changeURL`) | â€•         | â€•                      | âœ“               |

---

## ActivityPub ãƒ•ãƒƒã‚¯

`activityPub.objects.accepts` ã«æŒ‡å®šã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å—ä¿¡ã™ã‚‹ã¨ã€å„ Pack ã®
`canAccept` â†’ `onReceive` ãŒé †ã«å‘¼ã°ã‚Œã¾ã™ã€‚`serial: true`
ã‚’æŒ‡å®šã™ã‚‹ã¨å„ªå…ˆåº¦é †ã«é€æ¬¡å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ ã“ã‚Œã‚‰ã® API
ã¯ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¤ãƒ¼å°‚ç”¨ã§ã™ã€‚åˆ©ç”¨å¯èƒ½ãªãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¤ã„ã¦ã¯[ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥ API åˆ©ç”¨å¯å¦](#ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥-api-åˆ©ç”¨å¯å¦)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

```javascript
const afterA = await PackA.onReceive(obj);
const afterB = await PackB.onReceive(afterA);
```

---

## ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©

`eventDefinitions` ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’å®£è¨€ã—ã€`server.js` ç­‰ã§ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```jsonc
{
  "eventDefinitions": {
    "myEvent": {
      "source": "client",
      "handler": "onMyEvent"
    }
  }
}
```

- é€ä¿¡å…ƒã¯ `client`ã€`server`ã€`background`ã€`ui` ã®ã„ãšã‚Œã‹
- å¯¾è±¡ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®Ÿè£…ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã§æ±ºã¾ã‚Šã¾ã™

ã‚µãƒ¼ãƒãƒ¼å´ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¯ `[200|400|500, body]` ã‚’è¿”ã—ã¾ã™ã€‚

å®šç¾©ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã¯ã€ã©ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰ã‚‚å…±é€šã®
`takos.events.publish(eventName, payload, options?)`
ã§ç™ºè¡Œã§ãã¾ã™ã€‚åˆ©ç”¨å¯èƒ½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¾ã¨ã‚ã¯[ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥ API åˆ©ç”¨å¯å¦](#ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥-api-åˆ©ç”¨å¯å¦)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

## v2.1ã‹ã‚‰ã®ç§»è¡Œã‚¬ã‚¤ãƒ‰

1. æ¨©é™å®£è¨€ã‚’ `manifest.permissions` ã«é›†ç´„ã€‚
2. ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©ã¯ `source` ã®ã¿ã‚’æŒ‡å®šã—ã€ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å®Ÿè£…å´ãŒå—ä¿¡å…ˆã¨ãªã‚Šã¾ã™ã€‚
3. ActivityPub API ã¯ `activityPub()` ã«çµ±åˆã€‚
4. `extensionDependencies` ã¨ `exports` ã‚’åˆ©ç”¨ã—ã€`takos.extensions` API
   ã§ä»–æ‹¡å¼µã¨é€£æºã€‚

---

## Sandbox å®Ÿè¡Œç’°å¢ƒ

- ã™ã¹ã¦ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã§åˆ†é›¢ã•ã‚Œã¾ã™ã€‚
- `activate()` ã®æˆ»ã‚Šå€¤ã¯ structuredClone æº–æ‹ ã§ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã€‚
- å‘¼ã³å‡ºã—æ¨©é™ã¯ export å…ƒã®ç¯„å›²ã«é™å®šã•ã‚Œã€ä¾å­˜å¾ªç’°ã¯ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã™ã€‚

---

## æ‹¡å¼µæ©Ÿèƒ½é–“APIé€£æº

### è¨˜è¿°æ–¹æ³•

- `extensionDependencies` ã§ä¾å­˜ Pack ã‚’å®£è¨€ã—ã€æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã¯ UI ã§é€šçŸ¥ã€‚
- `exports` ã§å…¬é–‹é–¢æ•°ã‚’ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã«åˆ—æŒ™ã—ã¾ã™ã€‚

### æ¨©é™åˆ¶å¾¡

- `extensions:export` ä»–æ‹¡å¼µã¸ API ã‚’å…¬é–‹ã™ã‚‹æ¨©é™ã€‚
- `extensions:invoke` ä»–æ‹¡å¼µã® API ã‚’å–å¾—ã™ã‚‹æ¨©é™ã€‚

### åˆ©ç”¨æ–¹æ³•

```javascript
const ext = takos.extensions.get("com.example.lib");
if (ext) {
  const api = await ext.activate();
  await api.publish("doSomething");
}
```

TypeScript ã§å‹å®‰å…¨ã«é€£æºã§ãã€npm-semver æº–æ‹ ã§ä¾å­˜è§£æ±ºã•ã‚Œã¾ã™ã€‚

## UI URLæ“ä½œ

UI ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ç”»é¢é·ç§»ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã® API
ã§ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã‚„ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‹ã‚‰ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚
åˆ©ç”¨ã§ãã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¸€è¦§ã¯[ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥ API åˆ©ç”¨å¯å¦](#ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥-api-åˆ©ç”¨å¯å¦)ã‚‚å‚ç…§ã—ã¦ãã ã•ã„ã€‚

- **getURL**: `takos.getURL(): string[]`
  - ç¾åœ¨ã® URL ãƒ‘ã‚¹ã‚’é…åˆ—ã§å–å¾—ã—ã¾ã™ã€‚
- **pushURL**:
  `takos.pushURL(segment: string, options?: { showBar?: boolean }): void`
  - `segment` ã‚’æœ«å°¾ã«è¿½åŠ ã—ã¦é·ç§»ã—ã¾ã™ã€‚
- **setURL**:
  `takos.setURL(segments: string[], options?: { showBar?: boolean }): void`
  - URL å…¨ä½“ã‚’é…åˆ—ã§æŒ‡å®šã—ã¦é·ç§»ã—ã¾ã™ã€‚
- **changeURL**:
  `takos.changeURL(listener: (e: { url: string[] }) => void): () => void`
  - URL å¤‰æ›´æ™‚ã« `listener` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚æˆ»ã‚Šå€¤ã¯è§£é™¤é–¢æ•°ã§ã™ã€‚

**å¿…è¦æ¨©é™**: ãªã— (UI ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ä½¿ç”¨å¯)
