# 🐙 Takos 拡張機能仕様書 v3

> **仕様バージョン**: v3.0 (ドラフト) **最終更新**: 2025-06-11

## 🎯 目次

1. [目的](#目的)
2. [用語](#用語)
3. [パッケージ構造](#パッケージ構造)
4. [manifest.json 詳細仕様](#manifestjson-詳細仕様)
5. [名前空間と衝突回避](#名前空間と衝突回避)
6. [APIと権限](#apiと権限)
7. [globalThis.takos API](#globalthistakos-api)
8. [ActivityPub フック](#activitypub-フック)
9. [イベント定義](#イベント定義)
10. [v2.1からの移行ガイド](#v21からの移行ガイド)
11. [Sandbox 実行環境](#sandbox-実行環境)
12. [拡張機能間API連携](#拡張機能間api連携)
13. [UI URL操作](#ui-url操作)

---

## 目的

Takos を VSCode ライクに安全かつ柔軟に拡張するための共通仕様を定義します。拡張は
**server.js**、**client.js**、**index.html** の 3 ファイルで完結し、Deno
互換環境上で実行されます。

---

## 用語

| 用語                  | 説明                                                       |
| --------------------- | ---------------------------------------------------------- |
| Pack (.takopack)      | zip 形式の拡張パッケージ。トップに `takos/` フォルダを持つ |
| Identifier            | `com.example.foo` のような逆 FQDN。`takos` は予約済み      |
| Permission            | `resource:action(:scope)` 形式の権限文字列                 |
| ExtensionDependencies | 他拡張への依存定義                                         |
| Exports               | 外部公開 API の一覧                                        |

---

## パッケージ構造

```
awesome-pack.takopack
└─ takos/
   ├─ manifest.json  # 必須
   ├─ server.js      # サーバー
   ├─ client.js      # バックグラウンド
   └─ index.html     # UI
```

`server.js` と `client.js` は依存のない単一ファイルです。`index.html` は UI
を提供します。`/api/extensions/<id>/ui` で読み込むと `client.js` も自動でロードされます。

---

## manifest.json 詳細仕様

`manifest.json` は [manifest.schema.json](./manifest.schema.json)
で検証できます。主なフィールドは次のとおりです。

```jsonc
{
  "name": "awesome-pack",
  "description": "拡張機能の説明",
  "version": "1.2.0",
  "identifier": "com.example.awesome",
  "icon": "./icon.png",
  "apiVersion": "3.0",

  "extensionDependencies": [
    { "identifier": "com.example.lib", "version": "^1.0.0" }
  ],

  "exports": {
    "server": ["calculateHash", "sign"],
    "background": [],
    "ui": []
  },

  "permissions": [
    "fetch:net",
    "activitypub:send",
    "activitypub:read",
    "activitypub:receive:hook",
    "activitypub:actor:read",
    "activitypub:actor:write",
    "plugin-actor:create",
    "plugin-actor:read",
    "plugin-actor:write",
    "plugin-actor:delete",
    "kv:read",
    "kv:write",
    "cdn:read",
    "cdn:write",
    "events:publish",
    "extensions:invoke",
    "extensions:export",
    // denoの権限は特権的な操作を制限するために必要です
    // 基本的に要求しませんが、必要な場合は追加してください
    "deno:read",
    "deno:write",
    "deno:net",
    "deno:env",
    "deno:run",
    "deno:sys",
    "deno:ffi"
  ],

  "server": { "entry": "./server.js" },
  "client": {
    "entryUI": "./index.html",
    "entryBackground": "./client.js"
  },

  "activityPub": {
    "objects": [{
      "accepts": ["Note", "Create", "Like"],
      "context": "https://www.w3.org/ns/activitystreams",
      "hooks": {
        "canAccept": "canAccept",
        "onReceive": "onReceive",
        "priority": 1,
        "serial": false
      }
    }]
  },

  "eventDefinitions": {
    "postMessage": {
      "source": "client",
      "handler": "onPostMessage"
    },
    "notifyClient": {
      "source": "server",
      "handler": "onNotifyClient"
    }
  }
}
```

---

## 名前空間と衝突回避

- Identifier は逆 FQDN 形式を採用し衝突を避けます。
- KV とアセットは `identifier` 毎に名前空間分離されます。
  - KV: `${identifier}:${key}`
  - CDN: `${identifier}/${path}`
- 同名関数を export しても識別子ごとに独立するため衝突しません。
- 依存解決は npm-semver 準拠で最新版優先、警告あり。

---

## APIと権限

主要 API のメソッドシグネチャと必要権限は以下の通りです。

### ActivityPub

#### オブジェクト操作

- **send**: `takos.ap.send(userId: string, activity: object): Promise<void>`
  - **必要権限**: `activitypub:send`
- **read**: `takos.ap.read(id: string): Promise<object>`
  - **必要権限**: `activitypub:read`
- **delete**: `takos.ap.delete(id: string): Promise<void>`
  - **必要権限**: `activitypub:send`
- **list**: `takos.ap.list(userId?: string): Promise<string[]>`
  - **必要権限**: `activitypub:read`
  - **利用可能レイヤー**: `server` のみ

#### フック処理

- ActivityPub オブジェクト受信時のフック (`canAccept`, `onReceive`)
  - **必要権限**: `activitypub:receive:hook`

#### アクター操作

- **read**: `takos.ap.actor.read(userId: string): Promise<object>`
- **update**:
  `takos.ap.actor.update(userId: string, key: string, value: string): Promise<void>`
- **delete**:
  `takos.ap.actor.delete(userId: string, key: string): Promise<void>`
- **follow**:
  `takos.ap.follow(followerId: string, followeeId: string): Promise<void>`
- **unfollow**:
  `takos.ap.unfollow(followerId: string, followeeId: string): Promise<void>`
- **listFollowers**:
  `takos.ap.listFollowers(actorId: string): Promise<string[]>`
- **listFollowing**:
  `takos.ap.listFollowing(actorId: string): Promise<string[]>`
  - **必要権限**: `activitypub:actor:read` / `activitypub:actor:write`

### プラグインアクター操作

- **create**:
  `takos.ap.pluginActor.create(localName: string, profile: object): Promise<string>`
- **read**: `takos.ap.pluginActor.read(iri: string): Promise<object>`
- **update**:
  `takos.ap.pluginActor.update(iri: string, partial: object): Promise<void>`
- **delete**: `takos.ap.pluginActor.delete(iri: string): Promise<void>`
- **list**: `takos.ap.pluginActor.list(): Promise<string[]>`
  - **必要権限**: `plugin-actor:create` / `plugin-actor:read` /
    `plugin-actor:write` / `plugin-actor:delete`

### kv

- **read**: `takos.kv.read(key: string): Promise<any>`
- **write**: `takos.kv.write(key: string, value: any): Promise<void>`
- **delete**: `takos.kv.delete(key: string): Promise<void>`
- **list**: `takos.kv.list(): Promise<string[]>`
  - **必要権限**: `kv:read` / `kv:write`
  - `server.js` と `client.js` / `index.html` のストレージは独立
  - クライアント側では IndexedDB を利用したストアが使われ、サーバーとは同期されません

### fetch

- **fetch**: `takos.fetch(url: string, options?: object): Promise<Response>`
  - **必要権限**: `fetch:net` (クライアントでは `client.allowedConnectSrc`
    設定が必要)
  - `deno:net` 権限は不要です。サンドボックス内では `fetch()` が自動的に
    `takos.fetch()` へマップされます。

### cdn

- **read**: `takos.cdn.read(path: string): Promise<string>`
- **write**:
  `takos.cdn.write(path: string, data: string | Uint8Array, options?: { cacheTTL?: number }): Promise<string>`
- **delete**: `takos.cdn.delete(path: string): Promise<void>`
- **list**: `takos.cdn.list(prefix?: string): Promise<string[]>`
  - **必要権限**: `cdn:read` / `cdn:write`
  - **制限**: 合計 20MB まで。エンドポイント `/cdn/<identifier>/<path>`
  - **利用可能レイヤー**: `server` のみ

### events

イベントは manifest.json の `eventDefinitions` で宣言します。各レイヤー (server,
client, background, ui) からは同じ API で実行できます。

- `takos.events.publish(eventName: string, payload: any, options?: { push?: boolean; token?: string }): Promise<[number, object]> | Promise<void>`
  - 送信先が `server` の場合、ハンドラーが返す `[status, body]`
    を取得します。その他のレイヤー向けは `void` を返します。
  - `options.push` を `true` にすると、クライアントがオフラインでも FCM などの
    Push 通知経由でイベントを配信できます。`options.token` にはデバイスのトークンを指定してください。
  - イベントハンドラーは宣言されたファイル上のレイヤーで実行されます。
    `client` と `ui` ソースのイベントはブラウザ上で処理され、サーバーへは送信されません。

### 拡張間 API

- `takos.extensions.get(identifier: string): Extension | undefined`
- `Extension.activate(): Promise<{ publish(name: string, payload?: unknown): Promise<unknown> }>`
- `takos.activateExtension(identifier: string): Promise<{ publish(name: string, payload?: unknown): Promise<unknown> } | undefined>`
  - **必要権限**: `extensions:invoke` / `extensions:export`

権限はすべて `manifest.permissions` に列挙し、必要最低限を宣言してください。

---

## globalThis.takos API

Takos の各 API は `globalThis` 上の `takos` オブジェクトとして公開されます。
そのため、各スクリプトの冒頭で次のように取得して利用します。

```javascript
const { takos } = globalThis;
```

### 主なプロパティ

下表のように `takos` には拡張機能開発向けの API
群が集約されています。詳細なメソッドは[APIと権限](#apiと権限)を参照してください。

| プロパティ           | 役割                                                   |
| -------------------- | ------------------------------------------------------ |
| `ap` / `activitypub` | ActivityPub 連携用の API。投稿送信やアクター操作を行う |
| `kv`                 | 拡張ごとのキー/値ストア操作                            |
| `cdn`                | CDN へのファイル保存・取得                             |
| `events`             | レイヤー間イベントの発行・購読                         |
| `extensions`         | 他拡張の取得と `activate()` 実行                       |
| `activateExtension`  | ID 指定で拡張の `activate()` を実行                    |
| `fetch`              | 権限制御付きの `fetch` ラッパー                        |

```typescript
namespace takos.extensions {
  function get(identifier: string): Extension | undefined;
  const all: Extension[];
}
interface Extension {
  identifier: string;
  version: string;
  isActive: boolean;
  activate(): Promise<{
    publish(name: string, payload?: unknown): Promise<unknown>;
  }>;
}
function activateExtension(
  identifier: string,
): Promise<{ publish(name: string, payload?: unknown): Promise<unknown> }>;
```

利用例:

```javascript
// 従来の取得方法
const ext = takos.extensions.get("com.example.lib");
if (ext) {
  const api = await ext.activate();
  const hash = await api.publish("calculateHash", "hello");
}

// 直接有効化する方法
const api2 = await takos.activateExtension("com.example.lib");
if (api2) {
  const hash2 = await api2.publish("calculateHash", "world");
}
```

その他の API も `takos.*` 名前空間に集約されています。 ActivityPub API は
`takos.activitypub` のほか、短縮形の `takos.ap` からも利用できます。

### レイヤー別 API 利用可否

以下の表は、主要 API を各レイヤーから利用できるかを示します。

| API                                                         | server.js | client.js (background) | index.html (UI) |
| ----------------------------------------------------------- | --------- | ---------------------- | --------------- |
| `fetch`                                                     | ✓         | ✓                      | ✓               |
| `kv`                                                        | ✓         | ✓                      | ✓               |
| `cdn`                                                       | ✓         | ―                      | ―               |
| `events`                                                    | ✓         | ✓                      | ✓               |
| `activitypub`                                               | ✓         | ―                      | ―               |
| `extensions` / `activateExtension`                          | ✓         | ✓                      | ✓               |
| UI URL helpers (`getURL`, `pushURL`, `setURL`, `changeURL`) | ―         | ―                      | ✓               |

---

## ActivityPub フック

`activityPub.objects.accepts` に指定したオブジェクトを受信すると、各 Pack の
`canAccept` → `onReceive` が順に呼ばれます。`serial: true`
を指定すると優先度順に逐次実行されます。 これらの API
はサーバーレイヤー専用です。利用可能なレイヤーについては[レイヤー別 API 利用可否](#レイヤー別-api-利用可否)を参照してください。

```javascript
const afterA = await PackA.onReceive(obj);
const afterB = await PackB.onReceive(afterA);
```

---

## イベント定義

`eventDefinitions` にイベントを宣言し、`server.js` 等でハンドラーを実装します。

```jsonc
{
  "eventDefinitions": {
    "myEvent": {
      "source": "client",
      "handler": "onMyEvent"
    }
  }
}
```

- 送信元は `client`、`server`、`background`、`ui` のいずれか
- 対象レイヤーはハンドラーを実装したファイルで決まります

サーバー側ハンドラーは `[200|400|500, body]` を返します。

定義したイベントは、どのレイヤーからも共通の
`takos.events.publish(eventName, payload, options?)`
で発行できます。利用可能レイヤーのまとめは[レイヤー別 API 利用可否](#レイヤー別-api-利用可否)を参照してください。

---

## v2.1からの移行ガイド

1. 権限宣言を `manifest.permissions` に集約。
2. イベント定義は `source` のみを指定し、ハンドラー実装側が受信先となります。
3. ActivityPub API は `activityPub()` に統合。
4. `extensionDependencies` と `exports` を利用し、`takos.extensions` API
   で他拡張と連携。

---

## Sandbox 実行環境

- すべてのレイヤーはサンドボックスで分離されます。
- `activate()` の戻り値は structuredClone 準拠でシリアライズ。
- 呼び出し権限は export 元の範囲に限定され、依存循環はエラーとなります。

---

## 拡張機能間API連携

### 記述方法

- `extensionDependencies` で依存 Pack を宣言し、未インストール時は UI で通知。
- `exports` で公開関数をレイヤーごとに列挙します。

### 権限制御

- `extensions:export` 他拡張へ API を公開する権限。
- `extensions:invoke` 他拡張の API を取得する権限。

### 利用方法

```javascript
const ext = takos.extensions.get("com.example.lib");
if (ext) {
  const api = await ext.activate();
  await api.publish("doSomething");
}
```

TypeScript で型安全に連携でき、npm-semver 準拠で依存解決されます。

## UI URL操作

UI レイヤーで画面遷移を制御するための API
です。サーバーやバックグラウンドからは利用できません。
利用できるレイヤーの一覧は[レイヤー別 API 利用可否](#レイヤー別-api-利用可否)も参照してください。

- **getURL**: `takos.getURL(): string[]`
  - 現在の URL パスを配列で取得します。
- **pushURL**:
  `takos.pushURL(segment: string, options?: { showBar?: boolean }): void`
  - `segment` を末尾に追加して遷移します。
- **setURL**:
  `takos.setURL(segments: string[], options?: { showBar?: boolean }): void`
  - URL 全体を配列で指定して遷移します。
- **changeURL**:
  `takos.changeURL(listener: (e: { url: string[] }) => void): () => void`
  - URL 変更時に `listener` を呼び出します。戻り値は解除関数です。

**必要権限**: なし (UI レイヤーのみ使用可)
