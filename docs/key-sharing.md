# 鍵共有のしくみ

このソフトウェアではチャット機能でMLSを利用するため、各アカウントは公開鍵／秘密鍵のペアを保持します。秘密鍵はユーザーが入力するパスワードで暗号化され、サーバーに保存されます。
MLS
に関する暗号化・復号・グループ状態の更新はすべてクライアント側で完結し、サーバーは暗号化済みの鍵やメッセージを保存・配送するだけです。

## 基本的な流れ

1. 初回利用時にパスワードを入力すると、鍵ペアが生成されます。
2. 鍵ペアはパスワードで暗号化されてサーバーへ保存され、公開鍵は `KeyPackage`
   としてフォロワーに共有されます。各 `KeyPackage` ドキュメントには `tenant_id`
   フィールドが含まれ、インスタンスごとに区別されます。
3. 次回以降はログイン後に一度だけパスワードを入力し、秘密鍵を復号します。復号した鍵はセッション中のみ保持されます。
4. パスワードを忘れた場合は "鍵をリセット"
   を実行すると、サーバー上の暗号化済み鍵と公開鍵を削除し、ローカルに保存された情報も消去されます。
5. リセット後は再度パスワードを入力すると新しい鍵ペアが生成され、公開鍵が再共有されます。

この仕組みにより、ユーザーは一度のログインにつき一度だけパスワードを入力すればよく、安全に鍵を共有できます。
